<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ù…Ù†ØµØ© Ø§Ù„Ø§Ø³ØªÙ‚Ø±Ø§Ø± Ø§Ù„Ù…Ø§Ù„ÙŠ ÙˆØ§Ù„Ø§Ø¯Ø®Ø§Ø±ÙŠ</title>
    
    <!-- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª PWA Ù„ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¹Ù„Ù‰ Ø§Ù„Ù‡Ø§ØªÙ -->
    <meta name="application-name" content="Ø§Ù„Ù…Ø³ØªÙ‚Ø± Ø§Ù„Ù…Ø§Ù„ÙŠ">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Ø§Ù„Ù…Ø³ØªÙ‚Ø± Ø§Ù„Ù…Ø§Ù„ÙŠ">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#4c46e9">
    
    <!-- Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¨Ø£Ø­Ø¬Ø§Ù… Ù…Ø®ØªÙ„ÙØ© (Ø±Ù…ÙˆØ² ØªØ¹Ø¨ÙŠØ±ÙŠØ© ÙƒØ£ÙŠÙ‚ÙˆÙ†Ø§Øª Ù…Ø¤Ù‚ØªØ© - ÙŠÙ…ÙƒÙ† Ø§Ø³ØªØ¨Ø¯Ø§Ù„Ù‡Ø§ Ø¨ØµÙˆØ± Ø­Ù‚ÙŠÙ‚ÙŠØ©) -->
    <link rel="icon" type="image/png" sizes="192x192" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='45' fill='%234c46e9'/%3E%3Ctext x='50' y='70' font-size='50' text-anchor='middle' fill='white' font-family='Arial'%3EğŸ’°%3C/text%3E%3C/svg%3E">
    <link rel="icon" type="image/png" sizes="512x512" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='45' fill='%234c46e9'/%3E%3Ctext x='50' y='70' font-size='50' text-anchor='middle' fill='white' font-family='Arial'%3EğŸ’°%3C/text%3E%3C/svg%3E">
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='45' fill='%234c46e9'/%3E%3Ctext x='50' y='70' font-size='50' text-anchor='middle' fill='white' font-family='Arial'%3EğŸ’°%3C/text%3E%3C/svg%3E">
    
    <!-- Ø±Ø§Ø¨Ø· Ø§Ù„Ø¨ÙŠØ§Ù† (manifest) Ù„Ù„ØªØ·Ø¨ÙŠÙ‚ -->
    <link rel="manifest" href="data:application/manifest+json,%7B%22name%22%3A%22%D8%A7%D9%84%D9%85%D8%B3%D8%AA%D9%82%D8%B1%20%D8%A7%D9%84%D9%85%D8%A7%D9%84%D9%8A%22%2C%22short_name%22%3A%22%D9%85%D8%B3%D8%AA%D9%82%D8%B1%22%2C%22description%22%3A%22%D9%85%D9%86%D8%B5%D8%A9%20%D9%84%D8%A5%D8%AF%D8%A7%D8%B1%D8%A9%20%D8%A7%D9%84%D8%B3%D9%84%D9%81%20%D9%88%D8%A7%D9%84%D9%85%D8%B4%D8%AA%D8%B1%D9%8A%D8%A7%D8%AA%20%D8%A8%D8%A7%D9%84%D8%AF%D9%8A%D9%86%22%2C%22start_url%22%3A%22%2F%22%2C%22display%22%3A%22standalone%22%2C%22background_color%22%3A%22%234c46e9%22%2C%22theme_color%22%3A%22%234c46e9%22%2C%22icons%22%3A%5B%7B%22src%22%3A%22data:image/svg+xml,%253Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%253E%253Ccircle cx='50' cy='50' r='45' fill='%25234c46e9'/%253E%253Ctext x='50' y='70' font-size='50' text-anchor='middle' fill='white' font-family='Arial'%253EğŸ’°%253C/text%253E%253C/svg%253E%22%2C%22sizes%22%3A%22192x192%22%2C%22type%22%3A%22image/svg+xml%22%7D%2C%7B%22src%22%3A%22data:image/svg+xml,%253Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%253E%253Ccircle cx='50' cy='50' r='45' fill='%25234c46e9'/%253E%253Ctext x='50' y='70' font-size='50' text-anchor='middle' fill='white' font-family='Arial'%253EğŸ’°%253C/text%253E%253C/svg%253E%22%2C%22sizes%22%3A%22512x512%22%2C%22type%22%3A%22image/svg+xml%22%7D%5D%7D">
    
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
            user-select: none;
        }
        :root {
            --primary-blue: #4c46e9;
            --danger-red: #e11d48;
            --dark-red: #8b0000;
            --success-green: #10b981;
            --gold: #ffeb3b;
            --bg-light: #f1f3f9;
            --shadow: 0 10px 25px -5px rgba(0,0,0,0.1);
        }
        body {
            font-family: 'Cairo', sans-serif;
            background-color: var(--bg-light);
            margin: 0; padding: 0;
            height: 100vh; overflow: hidden;
            display: flex; flex-direction: column;
        }
        .app-header {
            background: linear-gradient(145deg, var(--primary-blue), #2a23b5);
            color: white; 
            padding: 10px 15px 8px;
            border-radius: 0 0 28px 28px; 
            flex-shrink: 0;
            position: relative; 
            box-shadow: var(--shadow);
        }
        
        /* Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø«Ø§Ø¨Øª ÙÙŠ Ø§Ù„Ø£Ø¹Ù„Ù‰ */
        .fixed-title {
            font-size: 20px;
            font-weight: 900;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            line-height: 1.3;
            margin-bottom: 5px;
            text-align: center;
        }
        
        /* Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù†ÙŠ: Ø²Ø± Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© + Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…ØªØ­Ø±Ùƒ */
        .second-row {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            position: relative;
            min-height: 40px;
        }
        
        /* Ø²Ø± Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© */
        .menu-btn {
            font-size: 24px; 
            cursor: pointer;
            width: 36px; 
            height: 36px;
            display: flex; 
            align-items: center; 
            justify-content: center;
            border-radius: 50%; 
            background: rgba(255,255,255,0.15);
            transition: 0.2s;
            flex-shrink: 0;
        }
        .menu-btn:active { background: rgba(255,255,255,0.3); }
        
        /* Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…ØªØ­Ø±Ùƒ */
        .dynamic-title {
            font-size: 16px;
            font-weight: 700;
            color: var(--gold);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        /* Ø²Ø± Ø§Ù„Ø±Ø¬ÙˆØ¹ */
        .back-btn {
            font-size: 14px; 
            cursor: pointer;
            background: rgba(255,255,255,0.2); 
            padding: 4px 12px;
            border-radius: 40px; 
            display: none; 
            border: none; 
            color: white;
            font-family: 'Cairo'; 
            font-weight: 700; 
            letter-spacing: 0.3px;
            backdrop-filter: blur(4px);
            margin-left: auto;
        }
        
        /* Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© */
        .sidebar {
            position: fixed; 
            right: -260px; 
            top: 0; 
            width: 240px; 
            height: 100%;
            background: white; 
            box-shadow: -5px 0 25px rgba(0,0,0,0.15);
            transition: 0.3s cubic-bezier(0.2, 0.9, 0.3, 1); 
            z-index: 1000;
            padding: 20px 12px; 
            border-radius: 30px 0 0 30px;
        }
        .sidebar.open { right: 0; }
        
        /* Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© Ù…Ø¹ Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª */
        .sidebar-item {
            padding: 12px 15px; 
            margin-bottom: 8px; 
            border-radius: 16px;
            display: flex; 
            align-items: center; 
            gap: 12px;
            cursor: pointer; 
            font-weight: 700; 
            color: #1e293b;
            font-size: 15px; 
            transition: 0.2s;
        }
        .sidebar-item:hover { background: #ede9fe; color: var(--primary-blue); }
        
        /* Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© */
        .sidebar-icon {
            font-size: 24px;
            width: 30px;
            text-align: center;
        }
        
        .sidebar-overlay {
            position: fixed; top:0; left:0; width:100%; height:100%;
            background: rgba(0,0,0,0.4); display:none; z-index: 999;
            backdrop-filter: blur(3px);
        }
        .container {
            flex: 1; overflow-y: auto; padding: 15px 15px 40px;
            scroll-behavior: smooth;
        }
        .card {
            background: white; border-radius: 24px; padding: 16px 14px;
            box-shadow: 0 6px 18px rgba(0,0,0,0.04); margin-bottom: 16px;
            border: 1px solid rgba(255,255,255,0.6);
        }
        .stats-row {
            display: flex;
            justify-content: space-between;
            gap: 8px;
            margin-bottom: 12px;
        }
        .stat-item {
            flex: 1;
            background: #f8fafc;
            border-radius: 20px;
            padding: 10px 3px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.02);
            border: 1px solid #eef2f6;
        }
        .stat-label {
            font-size: 13px;
            color: #64748b;
            font-weight: 600;
        }
        .stat-value {
            font-size: 20px;
            font-weight: 900;
            line-height: 1.2;
        }
        .stat-value.total { color: var(--primary-blue); }
        .stat-value.paid { color: var(--success-green); }
        .stat-value.remaining { color: #f97316; }
        input, select {
            width: 100%; padding: 12px 14px; margin-bottom: 10px;
            border: 2px solid #e9eef2; border-radius: 18px;
            font-family: 'Cairo'; font-size: 15px; background: #fafcff;
            outline: none; transition: 0.15s;
        }
        input:focus, select:focus { border-color: var(--primary-blue); background: white; }
        .btn {
            border: none; border-radius: 18px; font-family: 'Cairo';
            font-weight: 800; cursor: pointer; padding: 12px 10px;
            width: 100%; font-size: 15px; transition: 0.2s;
        }
        .btn:active { transform: scale(0.97); }
        .btn-blue { background: var(--primary-blue); color: white; box-shadow: 0 5px 0 #2a23b5; }
        .btn-blue:active { box-shadow: 0 2px 0 #2a23b5; transform: translateY(3px); }
        .btn-update {
            background: #2563eb; color: white; display: none;
            box-shadow: 0 5px 0 #1e3f8f;
        }
        table {
            width: 100%; border-collapse: collapse; background: white;
            border-radius: 20px; overflow: hidden; margin-top:8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.03);
        }
        th {
            background: #f2f5fe; padding: 10px 3px; font-size: 12px;
            color: #1e293b; font-weight: 800;
        }
        td {
            padding: 12px 3px; text-align: center; border-bottom: 1px solid #ecf1f6;
            font-weight: 700; font-size: 15px;
        }
        .clickable-amt {
            color: var(--primary-blue); cursor: pointer;
            text-decoration: underline dotted; font-weight: 900;
        }
        .over-limit-row { background-color: #ffeff0; color: var(--dark-red); font-weight: 800; }
        .unknown-row { background-color: #f0f4ff; color: var(--primary-blue); font-weight: 800; }
        .page { display: none; }
        .page.active { display: block; }
        #lockMsgDebt {
            display: none; color: var(--dark-red); font-weight: 800;
            background: #fff0f0; padding: 12px; border-radius: 20px;
            text-align: center; border: 2px dashed #e11d48; margin-bottom: 15px;
        }
        .btn-del {
            background: #fee2e2; color: #b91c1c; border: none;
            border-radius: 40px; padding: 6px 12px; font-weight: 800;
        }
        .grand-total {
            font-size: 28px; font-weight: 900; color: var(--primary-blue);
            line-height: 1.2;
        }
        hr { border: 1px solid #eef2f6; margin: 14px 0; }
        .total-box {
            background: #f0f4ff;
            border-radius: 20px;
            padding: 12px;
            text-align: center;
        }
        .total-label {
            font-size: 15px;
            color: #475569;
            font-weight: 700;
        }
        .total-value {
            font-size: 32px;
            font-weight: 900;
        }
        /* ØªÙ„ÙˆÙŠÙ† Ø§Ù„ØµÙÙˆÙ Ø­Ø³Ø¨ ÙˆØ¬ÙˆØ¯ ØªÙØ§ØµÙŠÙ„ */
        tr.purchase-with-details {
            background-color: #e6f7e6 !important;
        }
        tr.purchase-with-details td {
            color: #0a5c0a;
            font-weight: 800;
        }
        tr.purchase-no-details {
            background-color: white;
        }
        tr.payment-row {
            background-color: #f0f0f0;
        }
        .store-name-badge {
            background: #f97316;
            color: white;
            padding: 3px 10px;
            border-radius: 30px;
            font-size: 13px;
            display: inline-block;
            margin-bottom: 8px;
        }
        /* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© */
        .home-header {
            text-align: center;
            margin-bottom: 15px;
        }
        .chart-container {
            background: white;
            border-radius: 24px;
            padding: 15px;
            box-shadow: var(--shadow);
            margin-bottom: 15px;
        }
        canvas {
            max-height: 300px;
            width: 100% !important;
        }
        
        /* Ø±Ø³Ø§Ù„Ø© ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ */
        .install-prompt {
            background: white;
            border-radius: 20px;
            padding: 12px 15px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border: 2px solid var(--primary-blue);
        }
        .install-btn {
            background: var(--primary-blue);
            color: white;
            border: none;
            border-radius: 40px;
            padding: 8px 16px;
            font-weight: 700;
            cursor: pointer;
        }
    </style>
</head>
<body>
<div class="sidebar-overlay" id="overlay" onclick="toggleSidebar()"></div>
<div class="sidebar" id="sidebar">
    <div style="display: flex; flex-direction: column; height: 100%;">
        <div style="text-align:center; margin: 10px 0 20px;">
            <span style="font-size: 48px;">ğŸ’°</span>
            <h3 style="color: var(--primary-blue); margin:5px 0 0; font-size:18px;">Ø§Ù„Ù…Ø³ØªÙ‚Ø± Ø§Ù„Ù…Ø§Ù„ÙŠ</h3>
        </div>
        
        <!-- Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ù…Ø¹ Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª -->
        <div class="sidebar-item" onclick="showPage('tabHomepage')">
            <span class="sidebar-icon">ğŸ </span>
            <span>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span>
        </div>
        <div class="sidebar-item" onclick="showPage('tabBorrow')">
            <span class="sidebar-icon">ğŸ’¸</span>
            <span>Ø§Ù„Ø³Ù„Ù (Ø¹Ù„ÙŠ)</span>
        </div>
        <div class="sidebar-item" onclick="showPage('tabDebtHome')">
            <span class="sidebar-icon">ğŸ›’</span>
            <span>Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª Ø¨Ø§Ù„Ø¯ÙŠÙ†</span>
        </div>
        <div class="sidebar-item" onclick="showPage('tabSave')">
            <span class="sidebar-icon">ğŸ’°</span>
            <span>Ø§Ù„Ø§Ø¯Ø®Ø§Ø±</span>
        </div>
        <div class="sidebar-item" onclick="showPage('tabTotals')">
            <span class="sidebar-icon">ğŸ“Š</span>
            <span>Ø§Ù„Ù…Ø¬Ø§Ù…ÙŠØ¹</span>
        </div>
        
        <div style="flex:1;"></div>
        
        <!-- Ø¥Ø´Ø¹Ø§Ø± ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ -->
        <div style="font-size:12px; color:#aaa; text-align:center; padding:10px;">
            âœ“ Ø­ÙØ¸ ØªÙ„Ù‚Ø§Ø¦ÙŠ<br>
            <span style="font-size:10px;">Ø£Ø¶Ù Ù„Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø³Ø±ÙŠØ¹</span>
        </div>
    </div>
</div>

<div class="app-header">
    <!-- Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø«Ø§Ø¨Øª ÙÙŠ Ø§Ù„Ø£Ø¹Ù„Ù‰ -->
    <div class="fixed-title">
        <span>ğŸ’°</span> Ù…Ù†ØµØ© Ø§Ù„Ø§Ø³ØªÙ‚Ø±Ø§Ø± Ø§Ù„Ù…Ø§Ù„ÙŠ ÙˆØ§Ù„Ø§Ø¯Ø®Ø§Ø±ÙŠ
    </div>
    
    <!-- Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù†ÙŠ: Ø²Ø± Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© + Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…ØªØ­Ø±Ùƒ + Ø²Ø± Ø§Ù„Ø±Ø¬ÙˆØ¹ -->
    <div class="second-row">
        <div class="menu-btn" onclick="toggleSidebar()">â˜°</div>
        <div id="dynamicTitle" class="dynamic-title">
            <span>ğŸ </span> Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Â· Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ
        </div>
        <button id="btnBack" class="back-btn" onclick="goBack()">â†© Ø±Ø¬ÙˆØ¹</button>
    </div>
</div>

<!-- Ø±Ø³Ø§Ù„Ø© ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ (ØªØ¸Ù‡Ø± ÙÙŠ Ø§Ù„Ù…ØªØµÙØ­Ø§Øª Ø§Ù„ØªÙŠ ØªØ¯Ø¹Ù… Ø§Ù„ØªØ«Ø¨ÙŠØª) -->
<div id="installMessage" style="display: none;" class="install-prompt">
    <span>ğŸ“± Ø«Ø¨Øª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¹Ù„Ù‰ Ù‡Ø§ØªÙÙƒ Ù„Ù„ÙˆØµÙˆÙ„ Ø§Ù„Ø³Ø±ÙŠØ¹</span>
    <button id="installBtn" class="install-btn">ØªØ«Ø¨ÙŠØª</button>
</div>

<div class="container">
    <!-- ================ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© (Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ ÙÙ‚Ø·) ================ -->
    <div id="tabHomepage" class="page active">
        <div class="home-header">
            <h2 style="font-size: 22px; font-weight: 900; color: var(--primary-blue); margin:0;">ğŸ“Š Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø§Ù„ÙŠ Ø§Ù„Ø­Ø§Ù„ÙŠ</h2>
        </div>
        <div class="chart-container">
            <canvas id="financialChart"></canvas>
        </div>
    </div>

    <!-- Ø§Ù„Ø³Ù„Ù (Ø¹Ù„ÙŠ) - Ø£Ù†Ø§ Ø§Ø³ØªÙ„ÙØª Ù…Ù† Ù†Ø§Ø³ -->
    <div id="tabBorrow" class="page">
        <div class="card" style="background: linear-gradient(145deg, #f0f9ff, #fff);">
            <h3 style="margin:0 0 8px; display:flex; align-items:center; gap:6px; font-size:18px;">
                <span style="font-size:24px;">ğŸ’¸</span> Ø§Ù„Ø³Ù„Ù (Ø¹Ù„ÙŠ) ğŸ‘ˆ Ø§Ø³ØªÙ„ÙØª Ù…Ù† Ù†Ø§Ø³
            </h3>
            <p style="color:#64748b; font-size:13px; margin-top:-3px;">Ø£Ø´Ø®Ø§Øµ Ø£Ù‚Ø±Ø¶ÙˆÙ†ÙŠ Ù…Ø§Ù„Ø§Ù‹ (Ø³Ù„ÙØ© Ù†Ù‚Ø¯ÙŠØ©)</p>
            <input type="text" id="bName" placeholder="Ø§Ø³Ù… Ø§Ù„Ø´Ø®Øµ (Ø§Ù„Ø¯Ø§Ø¦Ù†)">
            <input type="number" id="bAmt" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø³ØªÙ„Ù (Ø¹Ù„ÙŠ)">
            <button class="btn" style="background:#0284c7; color:white; box-shadow:0 4px 0 #075985;" onclick="addBorrow()">â• ØªØ³Ø¬ÙŠÙ„ Ø³Ù„ÙØ© Ø¬Ø¯ÙŠØ¯Ø©</button>
        </div>
        <table>
            <thead><tr><th>Ø§Ù„Ø´Ø®Øµ</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th><th>Ø­Ø°Ù</th></tr></thead>
            <tbody id="borrowTable"></tbody>
        </table>
    </div>

    <!-- Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª Ø¨Ø§Ù„Ø¯ÙŠÙ† -->
    <div id="tabDebtHome" class="page">
        <div class="card" style="text-align: center; background: linear-gradient(145deg, #fff7ed, #fff);">
            <small style="opacity:0.7;">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª Ø¨Ø§Ù„Ø¯ÙŠÙ† (Ø¹Ù„ÙŠ) ğŸ‘ˆ Ø¹Ù„ÙŠ Ù„Ù„ØªØ¬Ø§Ø±</small>
            <div id="grandDebtOwed" class="grand-total" style="color:#f97316;">0 Ø¯Ø¬</div>
        </div>
        <div class="card" style="background:#fff7ed;">
            <input type="text" id="storeName" placeholder="Ø§Ø³Ù… Ø§Ù„ØªØ§Ø¬Ø± / Ø§Ù„Ù…Ø­Ù„ (Ø¹Ù„ÙŠ Ø¯ÙŠÙ†)">
            <input type="number" id="storeInit" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø£ÙˆÙ„ÙŠ (Ø¹Ù„ÙŠ)">
            <button class="btn" style="background:#f97316; color:white; box-shadow:0 4px 0 #c2410c;" onclick="addStore()">â• Ø¥Ø¶Ø§ÙØ© ØªØ§Ø¬Ø± (Ø¹Ù„ÙŠ Ø¯ÙŠÙ†)</button>
        </div>
        <div id="storesList"></div>
    </div>

    <!-- ØµÙØ­Ø© Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª Ø¨Ø§Ù„Ø¯ÙŠÙ† (Ù„ÙƒÙ„ ØªØ§Ø¬Ø±) -->
    <div id="tabDebtOps" class="page">
        <div class="card" style="padding: 14px; background:#fff7ed;">
            <div class="store-name-badge" id="currentStoreName"></div>
            <div class="stats-row">
                <div class="stat-item">
                    <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª</div>
                    <div class="stat-value total" id="debtStatsTotal">0</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Ù…Ø¯ÙÙˆØ¹ Ù„Ù„ØªØ§Ø¬Ø±</div>
                    <div class="stat-value paid" id="debtStatsPaid">0</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ø¹Ù„ÙŠ</div>
                    <div class="stat-value remaining" id="debtStatsRemaining">0</div>
                </div>
            </div>
        </div>
        <div class="card" style="background:#fff7ed;">
            <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                <input type="date" id="debtODate" style="flex:2; min-width:120px;">
                <input type="number" id="debtOAmt" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº" style="flex:1;">
            </div>
            <div id="debtNormalBtns" style="display: flex; gap: 8px; margin-top:6px;">
                <button class="btn" style="background:#f59e0b; color:white; font-weight:800; flex:1; box-shadow:0 4px 0 #b45309; font-size:14px; padding:10px;" onclick="addDebtOp('Ù…Ø´ØªØ±ÙŠØ§Øª')">â• Ù…Ø´ØªØ±ÙŠØ§Øª Ø¬Ø¯ÙŠØ¯Ø©</button>
                <button class="btn" style="background:var(--success-green); color:white; flex:1; box-shadow:0 4px 0 #0b7e5a; font-size:14px; padding:10px;" onclick="addDebtOp('Ø¯ÙØ¹')">ğŸ’° Ø¯ÙØ¹ Ù„Ù„ØªØ§Ø¬Ø±</button>
            </div>
            <button id="debtUpdateBtn" class="btn btn-update" onclick="confirmDebtUpdate()" style="padding:10px;">âœ… ØªØ£ÙƒÙŠØ¯ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø¨Ù„Øº</button>
        </div>
        <table>
            <thead><tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th><th>Ù†ÙˆØ¹</th><th>ØªÙØ§ØµÙŠÙ„</th><th>Ø­Ø°Ù</th></tr></thead>
            <tbody id="debtOpsTable"></tbody>
        </table>
    </div>

    <!-- ØµÙØ­Ø© ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø³Ù„Ø¹ Ù„Ù„Ù…Ø´ØªØ±ÙŠØ§Øª Ø¨Ø§Ù„Ø¯ÙŠÙ† -->
    <div id="tabDebtDet" class="page">
        <div class="card" style="background:#fff7ed;">
            <div class="store-name-badge" id="currentStoreNameDet"></div>
            <div id="lockMsgDebt">âš ï¸ ØªÙ… ØªØ¬Ø§ÙˆØ² Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø£ØµÙ„ÙŠ! ÙŠØ¬Ø¨ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø£ÙˆÙ„Ø§Ù‹.</div>
            <div id="debtDetForm">
                <input type="text" id="debtDItem" placeholder="Ø§Ø³Ù… Ø§Ù„Ø³Ù„Ø¹Ø©">
                <div style="display:flex; gap:8px;">
                    <input type="number" id="debtDQty" placeholder="Ø§Ù„ÙƒÙ…ÙŠØ©" value="1">
                    <input type="number" id="debtDPrc" placeholder="Ø§Ù„Ø³Ø¹Ø±">
                </div>
                <button class="btn" style="background:#f97316; color:white; box-shadow:0 4px 0 #c2410c;" onclick="addDebtDet()">â• Ø¥Ø¶Ø§ÙØ© Ø³Ù„Ø¹Ø©</button>
            </div>
        </div>
        <table>
            <thead><tr style="background:#f97316; color:white;"><th>Ø§Ù„Ø³Ù„Ø¹Ø©</th><th>Ø§Ù„ÙƒÙ…ÙŠØ©</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th><th>Ø¥Ø²Ø§Ù„Ø©</th></tr></thead>
            <tbody id="debtDetTable"></tbody>
        </table>
    </div>

    <!-- Ø§Ù„Ø§Ø¯Ø®Ø§Ø± -->
    <div id="tabSave" class="page">
        <div class="card">
            <h3 style="margin:0 0 8px; font-size:18px;">ğŸ’° Ø§Ù„Ø§Ø¯Ø®Ø§Ø± Ø§Ù„Ø´Ø®ØµÙŠ</h3>
            <input type="text" id="sPlace" placeholder="Ø§Ù„Ù…ÙƒØ§Ù† / Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚">
            <input type="number" id="sAmt" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯Ø®Ø±">
            <button class="btn" style="background:var(--success-green); color:white; box-shadow:0 4px 0 #0b7e5a;" onclick="addSaving()">Ø¥ÙŠØ¯Ø§Ø¹ ÙÙŠ Ø§Ù„Ø§Ø¯Ø®Ø§Ø±</button>
        </div>
        <table>
            <thead><tr><th>Ø§Ù„Ù…ÙƒØ§Ù†</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th><th>Ø­Ø°Ù</th></tr></thead>
            <tbody id="savingsTable"></tbody>
        </table>
    </div>

    <!-- Ø§Ù„Ù…Ø¬Ø§Ù…ÙŠØ¹ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© -->
    <div id="tabTotals" class="page">
        <div class="card" style="background:white;">
            <div style="display:flex; justify-content: space-between; align-items:center; padding:8px 0;">
                <span style="font-weight:800; color:#0284c7; font-size:15px;">ğŸ’¸ Ø§Ù„Ø³Ù„Ù (Ø¹Ù„ÙŠ)</span>
                <b id="totB" style="font-size:20px; color:#0284c7;">0 Ø¯Ø¬</b>
            </div>
            <div style="display:flex; justify-content: space-between; align-items:center; padding:8px 0;">
                <span style="font-weight:800; color:#f97316; font-size:15px;">ğŸ›’ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª Ø¨Ø§Ù„Ø¯ÙŠÙ†</span>
                <b id="totOwed" style="font-size:20px; color:#f97316;">0 Ø¯Ø¬</b>
            </div>
            <div style="display:flex; justify-content: space-between; align-items:center; padding:8px 0;">
                <span style="font-weight:800; color:#0d7c5a; font-size:15px;">ğŸ¦ Ø§Ù„Ø§Ø¯Ø®Ø§Ø±</span>
                <b id="totS" style="font-size:20px; color:var(--success-green);">0 Ø¯Ø¬</b>
            </div>
            <hr>
            <div class="total-box">
                <div class="total-label">ğŸ’° Ø§Ù„ØµØ§ÙÙŠ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ</div>
                <div id="totFinal" class="total-value">0 Ø¯Ø¬</div>
                <p style="font-size:13px; color:#64748b; margin:5px 0 0;">
                    (Ø§Ù„ØµØ§ÙÙŠ = - Ø§Ù„Ø³Ù„Ù - Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª - Ø§Ù„Ø§Ø¯Ø®Ø§Ø±)
                </p>
            </div>
        </div>
    </div>
</div>

<!-- Ø³ÙƒØ±ÙŠØ¨Øª ØªØ­ÙˆÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¥Ù„Ù‰ PWA -->
<script>
    // ØªØ³Ø¬ÙŠÙ„ Service Worker
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('sw.js').catch(() => {});
    }
    
    // Ø¥Ù†Ø´Ø§Ø¡ Service Worker Ø¨Ø³ÙŠØ·
    const swScript = `
    self.addEventListener('install', e => {
        e.waitUntil(caches.open('finance-app').then(cache => 
            cache.addAll(['/', '/index.html', 'https://fonts.googleapis.com/css2?family=Cairo:wght@600;700;800&display=swap'])
        ));
    });
    self.addEventListener('fetch', e => {
        e.respondWith(caches.match(e.request).then(response => response || fetch(e.request)));
    });`;
    
    const blob = new Blob([swScript], { type: 'application/javascript' });
    const url = URL.createObjectURL(blob);
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register(url).catch(() => {});
    }
    
    // ÙƒÙˆØ¯ ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¹Ù„Ù‰ Ø§Ù„Ù‡Ø§ØªÙ
    let deferredPrompt;
    const installMessage = document.getElementById('installMessage');
    const installBtn = document.getElementById('installBtn');
    
    window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredPrompt = e;
        installMessage.style.display = 'flex';
    });
    
    installBtn.addEventListener('click', async () => {
        if (!deferredPrompt) return;
        deferredPrompt.prompt();
        const { outcome } = await deferredPrompt.userChoice;
        if (outcome === 'accepted') {
            installMessage.style.display = 'none';
        }
        deferredPrompt = null;
    });
</script>

<script>
    (function() {
        const STORAGE_KEY = "MY_STABLE_FINANCE_v14";
        
        let db = JSON.parse(localStorage.getItem(STORAGE_KEY)) || { 
            stores: {},
            borrows: [],
            savings: []
        };

        let curStore = "";
        let curStoreIdx = null;
        let editStoreIdx = null;
        
        let pageStack = ['tabHomepage'];

        let financialChart = null;

        window.toggleSidebar = function() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('overlay');
            sidebar.classList.toggle('open');
            overlay.style.display = sidebar.classList.contains('open') ? 'block' : 'none';
        };

        function saveToStorage() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(db));
        }

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…ØªØ­Ø±Ùƒ
        function updateDynamicTitle(icon, text) {
            document.getElementById('dynamicTitle').innerHTML = `<span>${icon}</span> ${text}`;
        }

        window.showPage = function(id, push = true) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            if (push && pageStack[pageStack.length - 1] !== id) pageStack.push(id);
            
            // Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ø²Ø± Ø§Ù„Ø±Ø¬ÙˆØ¹
            document.getElementById('btnBack').style.display = (id === 'tabHomepage' || id === 'tabBorrow' || id === 'tabDebtHome') ? 'none' : 'block';

            if (id === 'tabHomepage') { 
                updateDynamicTitle('ğŸ ', 'Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Â· Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ');
                updateHomepageChart(); 
            }
            else if (id === 'tabBorrow') { 
                updateDynamicTitle('ğŸ’¸', 'Ø§Ù„Ø³Ù„Ù (Ø¹Ù„ÙŠ) Â· Ø§Ø³ØªÙ„ÙØª Ù…Ù† Ù†Ø§Ø³');
                renderBorrows(); 
            }
            else if (id === 'tabDebtHome') { 
                updateDynamicTitle('ğŸ›’', 'Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª Ø¨Ø§Ù„Ø¯ÙŠÙ† Â· Ø¹Ù„ÙŠ Ù„Ù„ØªØ¬Ø§Ø±');
                renderStoresHome(); 
            }
            else if (id === 'tabDebtOps') {
                updateDynamicTitle('ğŸ›’', `${curStore} Â· Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª`);
                document.getElementById('currentStoreName').innerText = curStore;
                renderDebtOps();
                updateDebtStats();
            }
            else if (id === 'tabDebtDet') {
                updateDynamicTitle('ğŸ“‹', 'ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª');
                document.getElementById('currentStoreNameDet').innerText = curStore;
                renderDebtDet();
            }
            else if (id === 'tabSave') { 
                updateDynamicTitle('ğŸ’°', 'Ø§Ù„Ø§Ø¯Ø®Ø§Ø± Ø§Ù„Ø´Ø®ØµÙŠ');
                renderSavings(); 
            }
            else if (id === 'tabTotals') { 
                updateDynamicTitle('ğŸ“Š', 'Ø§Ù„Ù…Ø¬Ø§Ù…ÙŠØ¹ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©');
                calcFinal(); 
            }

            if (document.getElementById('sidebar').classList.contains('open')) window.toggleSidebar();
        };

        window.goBack = function() {
            if (pageStack.length > 1) {
                pageStack.pop();
                window.showPage(pageStack[pageStack.length - 1], false);
            }
        };

        // ================ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ ================
        function updateHomepageChart() {
            let totalBorrows = db.borrows.reduce((acc, b) => acc + b.amount, 0);
            let totalPurchases = 0;
            for (let n in db.stores) {
                totalPurchases += (db.stores[n].total - db.stores[n].paid);
            }
            let totalSavings = db.savings.reduce((acc, s) => acc + s.amount, 0);

            const ctx = document.getElementById('financialChart').getContext('2d');
            
            if (financialChart) {
                financialChart.destroy();
            }

            financialChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Ø§Ù„Ø³Ù„Ù (Ø¹Ù„ÙŠ)', 'Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª Ø¨Ø§Ù„Ø¯ÙŠÙ†', 'Ø§Ù„Ø§Ø¯Ø®Ø§Ø±'],
                    datasets: [{
                        label: 'Ø§Ù„Ù…Ø¨Ù„Øº (Ø¯Ø¬)',
                        data: [totalBorrows, totalPurchases, totalSavings],
                        backgroundColor: ['#0284c7', '#f97316', '#10b981'],
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: { rtl: true, titleAlign: 'right', bodyAlign: 'right' }
                    },
                    scales: {
                        y: { beginAtZero: true, grid: { color: '#e9eef2' } }
                    }
                }
            });
        }

        // ================ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª Ø¨Ø§Ù„Ø¯ÙŠÙ† ================
        window.addStore = function() {
            let name = document.getElementById('storeName').value.trim();
            let initAmount = parseFloat(document.getElementById('storeInit').value) || 0;
            if (!name) return alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„ØªØ§Ø¬Ø±");
            if (db.stores[name]) return alert("Ù‡Ø°Ø§ Ø§Ù„ØªØ§Ø¬Ø± Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ø§Ù‹");

            db.stores[name] = { total: initAmount, paid: 0, history: [] };
            if (initAmount > 0) {
                db.stores[name].history.push({ date: 'Ø¨Ø¯Ø§ÙŠØ©', amount: initAmount, type: 'Ù…Ø´ØªØ±ÙŠØ§Øª', details: [] });
            }
            saveToStorage();
            renderStoresHome();
            document.getElementById('storeName').value = '';
            document.getElementById('storeInit').value = '';
        };

        window.delStore = function(name) {
            if (confirm(`Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ§Ø¬Ø± "${name}"ØŸ`)) {
                delete db.stores[name];
                saveToStorage();
                renderStoresHome();
            }
        };

        function renderStoresHome() {
            let container = document.getElementById('storesList');
            let totalDebt = 0;
            container.innerHTML = '';
            for (let name in db.stores) {
                let remaining = (db.stores[name].total - db.stores[name].paid);
                totalDebt += remaining;
                container.innerHTML += `
                    <div class="card" style="padding:10px 14px; margin-bottom:8px; cursor:pointer; background:#fff7ed;" onclick="openStoreOps('${name}')">
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <div>
                                <span style="font-weight:900; font-size:17px;">${name}</span><br>
                                <span style="color:${remaining >= 0 ? '#c2410c' : '#059669'}; font-size:18px; font-weight:900;">
                                    Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: ${remaining} Ø¯Ø¬
                                </span>
                            </div>
                            <button class="btn-del" onclick="event.stopPropagation(); window.delStore('${name}')" style="padding:5px 10px;">ğŸ—‘</button>
                        </div>
                    </div>`;
            }
            document.getElementById('grandDebtOwed').innerText = totalDebt + ' Ø¯Ø¬';
        }

        window.openStoreOps = function(name) {
            curStore = name;
            window.showPage('tabDebtOps');
        };

        function renderDebtOps() {
            let history = db.stores[curStore].history || [];
            let tbody = document.getElementById('debtOpsTable');
            tbody.innerHTML = '';
            
            for (let i = history.length - 1; i >= 0; i--) {
                let op = history[i];
                let idx = i;
                
                if (op.type === 'Ù…Ø´ØªØ±ÙŠØ§Øª') {
                    let hasDetails = op.details && op.details.length > 0;
                    let rowClass = hasDetails ? 'purchase-with-details' : 'purchase-no-details';
                    
                    tbody.innerHTML += `<tr class="${rowClass}">
                        <td>${op.date || 'Ø¨Ø¯ÙˆÙ† ØªØ§Ø±ÙŠØ®'}</td>
                        <td class="clickable-amt" onclick="window.startDebtEdit(${idx}, ${op.amount})">${op.amount}</td>
                        <td>â• Ù…Ø´ØªØ±ÙŠØ§Øª</td>
                        <td><button class="btn" style="padding:4px; width:30px; background:#fff7ed; font-size:14px;" onclick="window.openDebtDet(${idx})">ğŸ“‹</button></td>
                        <td><span style="cursor:pointer; font-size:20px;" onclick="window.delDebtOp(${idx})">ğŸ—‘</span></td>
                    </tr>`;
                } else {
                    tbody.innerHTML += `<tr class="payment-row">
                        <td>${op.date || 'Ø¨Ø¯ÙˆÙ† ØªØ§Ø±ÙŠØ®'}</td>
                        <td class="clickable-amt" onclick="window.startDebtEdit(${idx}, ${op.amount})">${op.amount}</td>
                        <td>ğŸ’° Ø¯ÙØ¹</td>
                        <td>â€”</td>
                        <td><span style="cursor:pointer; font-size:20px;" onclick="window.delDebtOp(${idx})">ğŸ—‘</span></td>
                    </tr>`;
                }
            }
        }

        function updateDebtStats() {
            if (!curStore || !db.stores[curStore]) return;
            let store = db.stores[curStore];
            let total = store.total || 0;
            let paid = store.paid || 0;
            let remaining = total - paid;

            document.getElementById('debtStatsTotal').innerText = total + ' Ø¯Ø¬';
            document.getElementById('debtStatsPaid').innerText = paid + ' Ø¯Ø¬';
            document.getElementById('debtStatsRemaining').innerText = remaining + ' Ø¯Ø¬';
        }

        window.addDebtOp = function(type) {
            let amt = parseFloat(document.getElementById('debtOAmt').value);
            if (!amt || amt <= 0) return alert("Ø£Ø¯Ø®Ù„ Ù…Ø¨Ù„Øº ØµØ­ÙŠØ­");
            let date = document.getElementById('debtODate').value;
            let displayDate = date ? date.split('-').reverse().slice(0,2).join('/') : 'Ø§Ù„ÙŠÙˆÙ…';
            let store = db.stores[curStore];
            
            if (type === 'Ù…Ø´ØªØ±ÙŠØ§Øª') {
                store.total += amt;
                store.history.push({ date: displayDate, amount: amt, type: 'Ù…Ø´ØªØ±ÙŠØ§Øª', details: [] });
            } else {
                store.paid += amt;
                store.history.push({ date: displayDate, amount: amt, type: 'Ø¯ÙØ¹', details: [] });
            }

            saveToStorage();
            renderDebtOps();
            updateDebtStats();
            document.getElementById('debtOAmt').value = '';
        };

        window.startDebtEdit = function(idx, currentAmt) {
            editStoreIdx = idx;
            document.getElementById('debtOAmt').value = currentAmt;
            document.getElementById('debtNormalBtns').style.display = 'none';
            document.getElementById('debtUpdateBtn').style.display = 'block';
        };

        window.confirmDebtUpdate = function() {
            let newAmt = parseFloat(document.getElementById('debtOAmt').value);
            if (isNaN(newAmt) || newAmt < 0) return alert("Ù‚ÙŠÙ…Ø© ØºÙŠØ± ØµØ­ÙŠØ­Ø©");
            let store = db.stores[curStore];
            let op = store.history[editStoreIdx];
            let diff = newAmt - op.amount;
            if (op.type === 'Ù…Ø´ØªØ±ÙŠØ§Øª') store.total += diff;
            else store.paid += diff;
            op.amount = newAmt;
            saveToStorage();
            renderDebtOps();
            updateDebtStats();
            document.getElementById('debtNormalBtns').style.display = 'flex';
            document.getElementById('debtUpdateBtn').style.display = 'none';
            document.getElementById('debtOAmt').value = '';
        };

        window.delDebtOp = function(idx) {
            let store = db.stores[curStore];
            let op = store.history[idx];
            if (op.type === 'Ù…Ø´ØªØ±ÙŠØ§Øª') store.total -= op.amount;
            else store.paid -= op.amount;
            store.history.splice(idx, 1);
            saveToStorage();
            renderDebtOps();
            updateDebtStats();
        };

        // ================ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø³Ù„Ø¹ ================
        window.openDebtDet = function(opIdx) {
            curStoreIdx = opIdx;
            window.showPage('tabDebtDet');
        };

        function renderDebtDet() {
            let op = db.stores[curStore].history[curStoreIdx];
            if (!op.details) op.details = [];
            let sum = op.details.reduce((acc, d) => acc + (d.t || 0), 0);
            let tbody = document.getElementById('debtDetTable');
            tbody.innerHTML = '';
            op.details.forEach((d, i) => {
                tbody.innerHTML += `<tr><td>${d.n}</td><td>${d.q}</td><td>${d.t}</td><td><span style="cursor:pointer;font-size:20px;" onclick="window.delDebtDet(${i})">ğŸ—‘</span></td></tr>`;
            });
            let diff = op.amount - sum;
            if (diff < 0) {
                document.getElementById('debtDetForm').style.display = 'none';
                document.getElementById('lockMsgDebt').style.display = 'block';
                tbody.innerHTML += `<tr class="over-limit-row"><td colspan="2">ğŸš« ØªØ¬Ø§ÙˆØ²</td><td>${Math.abs(diff)}</td><td>-</td></tr>`;
            } else {
                document.getElementById('debtDetForm').style.display = 'block';
                document.getElementById('lockMsgDebt').style.display = 'none';
                if (diff > 0) {
                    tbody.innerHTML += `<tr class="unknown-row"><td colspan="2">âš ï¸ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ</td><td>${diff}</td><td>-</td></tr>`;
                }
            }
        }

        window.addDebtDet = function() {
            let item = document.getElementById('debtDItem').value.trim();
            let qty = parseFloat(document.getElementById('debtDQty').value) || 1;
            let price = parseFloat(document.getElementById('debtDPrc').value);
            if (!item || !price) return alert("Ø£Ø¯Ø®Ù„ Ø§Ù„Ø³Ù„Ø¹Ø© ÙˆØ§Ù„Ø³Ø¹Ø±");
            let totalItem = qty * price;
            let op = db.stores[curStore].history[curStoreIdx];
            if (!op.details) op.details = [];
            op.details.push({ n: item, q: qty, p: price, t: totalItem });
            saveToStorage();
            renderDebtDet();
            document.getElementById('debtDItem').value = '';
            document.getElementById('debtDQty').value = '1';
            document.getElementById('debtDPrc').value = '';
            renderDebtOps();
        };

        window.delDebtDet = function(detIdx) {
            db.stores[curStore].history[curStoreIdx].details.splice(detIdx, 1);
            saveToStorage();
            renderDebtDet();
            renderDebtOps();
        };

        // ================ Ø§Ù„Ø³Ù„Ù ================
        window.addBorrow = function() {
            let name = document.getElementById('bName').value.trim();
            let amt = parseFloat(document.getElementById('bAmt').value);
            if (!name || !amt) return alert("Ø§Ù…Ù„Ø£ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„");
            db.borrows.push({ name: name, amount: amt });
            saveToStorage();
            renderBorrows();
            document.getElementById('bName').value = '';
            document.getElementById('bAmt').value = '';
        };

        window.renderBorrows = function() {
            let tbody = document.getElementById('borrowTable');
            tbody.innerHTML = '';
            db.borrows.forEach((entry, i) => {
                tbody.innerHTML += `<tr><td>${entry.name}</td><td>${entry.amount} Ø¯Ø¬</td><td><span style="cursor:pointer;font-size:20px;" onclick="window.delBorrow(${i})">ğŸ—‘</span></td></tr>`;
            });
        };

        window.delBorrow = function(idx) {
            db.borrows.splice(idx, 1);
            saveToStorage();
            renderBorrows();
        };

        // ================ Ø§Ù„Ø§Ø¯Ø®Ø§Ø± ================
        window.addSaving = function() {
            let place = document.getElementById('sPlace').value.trim();
            let amt = parseFloat(document.getElementById('sAmt').value);
            if (!place || !amt) return alert("Ø§Ù…Ù„Ø£ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„");
            db.savings.push({ place: place, amount: amt });
            saveToStorage();
            renderSavings();
            document.getElementById('sPlace').value = '';
            document.getElementById('sAmt').value = '';
        };

        window.renderSavings = function() {
            let tbody = document.getElementById('savingsTable');
            tbody.innerHTML = '';
            db.savings.forEach((entry, i) => {
                tbody.innerHTML += `<tr><td>${entry.place}</td><td>${entry.amount} Ø¯Ø¬</td><td><span style="cursor:pointer;font-size:20px;" onclick="window.delSaving(${i})">ğŸ—‘</span></td></tr>`;
            });
        };

        window.delSaving = function(idx) {
            db.savings.splice(idx, 1);
            saveToStorage();
            renderSavings();
        };

        // ================ Ø§Ù„Ù…Ø¬Ø§Ù…ÙŠØ¹ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© ================
        function calcFinal() {
            let totalStoreDebt = 0;
            for (let n in db.stores) {
                totalStoreDebt += (db.stores[n].total - db.stores[n].paid);
            }
            let totalBorrows = db.borrows.reduce((acc, b) => acc + b.amount, 0);
            let totalSavings = db.savings.reduce((acc, s) => acc + s.amount, 0);
            let net = - totalBorrows - totalStoreDebt - totalSavings;

            document.getElementById('totB').innerText = totalBorrows + ' Ø¯Ø¬';
            document.getElementById('totOwed').innerText = totalStoreDebt + ' Ø¯Ø¬';
            document.getElementById('totS').innerText = totalSavings + ' Ø¯Ø¬';
            
            let finalEl = document.getElementById('totFinal');
            finalEl.innerText = net + ' Ø¯Ø¬';
            finalEl.style.color = net < 0 ? 'var(--danger-red)' : (net > 0 ? 'var(--success-green)' : '#64748b');
        }

        // Ø§Ù„ØªÙ‡ÙŠØ¦Ø©
        window.onload = function() {
            let today = new Date().toISOString().split('T')[0];
            document.getElementById('debtODate').value = today;
            
            renderBorrows();
            renderStoresHome();
            renderSavings();
            
            showPage('tabHomepage', false);
        };

        window.calcFinal = calcFinal;
        window.renderBorrows = renderBorrows;
        window.renderStoresHome = renderStoresHome;
        window.renderDebtOps = renderDebtOps;
        window.renderDebtDet = renderDebtDet;
        window.renderSavings = renderSavings;
        window.updateDebtStats = updateDebtStats;
    })();
</script>
</body>
</html>
