<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ù…Ù†ØµØ© Ø§Ù„Ø§Ø³ØªÙ‚Ø±Ø§Ø± Ø§Ù„Ù…Ø§Ù„ÙŠ ÙˆØ§Ù„Ø§Ø¯Ø®Ø§Ø±ÙŠ</title>
    
    <!-- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª PWA -->
    <meta name="application-name" content="Ø§Ù„Ù…Ø³ØªÙ‚Ø± Ø§Ù„Ù…Ø§Ù„ÙŠ">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Ø§Ù„Ù…Ø³ØªÙ‚Ø± Ø§Ù„Ù…Ø§Ù„ÙŠ">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#4c46e9">
    
    <!-- Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ -->
    <link rel="icon" type="image/png" sizes="192x192" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='45' fill='%234c46e9'/%3E%3Ctext x='50' y='70' font-size='50' text-anchor='middle' fill='white' font-family='Arial'%3EğŸ’°%3C/text%3E%3C/svg%3E">
    <link rel="icon" type="image/png" sizes="512x512" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='45' fill='%234c46e9'/%3E%3Ctext x='50' y='70' font-size='50' text-anchor='middle' fill='white' font-family='Arial'%3EğŸ’°%3C/text%3E%3C/svg%3E">
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='45' fill='%234c46e9'/%3E%3Ctext x='50' y='70' font-size='50' text-anchor='middle' fill='white' font-family='Arial'%3EğŸ’°%3C/text%3E%3C/svg%3E">
    
    <link rel="manifest" href="data:application/manifest+json,%7B%22name%22%3A%22%D8%A7%D9%84%D9%85%D8%B3%D8%AA%D9%82%D8%B1%20%D8%A7%D9%84%D9%85%D8%A7%D9%84%D9%8A%22%2C%22short_name%22%3A%22%D9%85%D8%B3%D8%AA%D9%82%D8%B1%22%2C%22description%22%3A%22%D9%85%D9%86%D8%B5%D8%A9%20%D9%84%D8%A5%D8%AF%D8%A7%D8%B1%D8%A9%20%D8%A7%D9%84%D8%B3%D9%84%D9%81%20%D9%88%D8%A7%D9%84%D9%85%D8%B4%D8%AA%D8%B1%D9%8A%D8%A7%D8%AA%20%D8%A8%D8%A7%D9%84%D8%AF%D9%8A%D9%86%22%2C%22start_url%22%3A%22%2F%22%2C%22display%22%3A%22standalone%22%2C%22background_color%22%3A%22%234c46e9%22%2C%22theme_color%22%3A%22%234c46e9%22%2C%22icons%22%3A%5B%7B%22src%22%3A%22data:image/svg+xml,%253Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%253E%253Ccircle cx='50' cy='50' r='45' fill='%25234c46e9'/%253E%253Ctext x='50' y='70' font-size='50' text-anchor='middle' fill='white' font-family='Arial'%253EğŸ’°%253C/text%253E%253C/svg%253E%22%2C%22sizes%22%3A%22192x192%22%2C%22type%22%3A%22image/svg+xml%22%7D%2C%7B%22src%22%3A%22data:image/svg+xml,%253Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%253E%253Ccircle cx='50' cy='50' r='45' fill='%25234c46e9'/%253E%253Ctext x='50' y='70' font-size='50' text-anchor='middle' fill='white' font-family='Arial'%253EğŸ’°%253C/text%253E%253C/svg%253E%22%2C%22sizes%22%3A%22512x512%22%2C%22type%22%3A%22image/svg+xml%22%7D%5D%7D">
    
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        /* Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù†Ù…Ø§Ø· Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© ÙƒÙ…Ø§ Ù‡ÙŠ (Ù„Ù… ÙŠØªÙ… ØªØºÙŠÙŠØ±Ù‡Ø§) */
        * {
            box-sizing: border-box;
            user-select: none;
        }
        :root {
            --primary-blue: #4c46e9;
            --danger-red: #e11d48;
            --dark-red: #8b0000;
            --success-green: #10b981;
            --gold: #ffeb3b;
            --bg-light: #f1f3f9;
            --shadow: 0 10px 25px -5px rgba(0,0,0,0.1);
        }
        body {
            font-family: 'Cairo', sans-serif;
            background-color: var(--bg-light);
            margin: 0; padding: 0;
            height: 100vh; overflow: hidden;
            display: flex; flex-direction: column;
        }
        .app-header {
            background: linear-gradient(145deg, var(--primary-blue), #2a23b5);
            color: white; 
            padding: 10px 15px 8px;
            border-radius: 0 0 28px 28px; 
            flex-shrink: 0;
            position: relative; 
            box-shadow: var(--shadow);
        }
        .fixed-title {
            font-size: 20px;
            font-weight: 900;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            line-height: 1.3;
            margin-bottom: 5px;
            text-align: center;
        }
        .second-row {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            position: relative;
            min-height: 40px;
        }
        .menu-btn {
            font-size: 24px; 
            cursor: pointer;
            width: 36px; 
            height: 36px;
            display: flex; 
            align-items: center; 
            justify-content: center;
            border-radius: 50%; 
            background: rgba(255,255,255,0.15);
            transition: 0.2s;
            flex-shrink: 0;
        }
        .menu-btn:active { background: rgba(255,255,255,0.3); }
        .dynamic-title {
            font-size: 16px;
            font-weight: 700;
            color: var(--gold);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .back-btn {
            font-size: 14px; 
            cursor: pointer;
            background: rgba(255,255,255,0.2); 
            padding: 4px 12px;
            border-radius: 40px; 
            display: none; 
            border: none; 
            color: white;
            font-family: 'Cairo'; 
            font-weight: 700; 
            letter-spacing: 0.3px;
            backdrop-filter: blur(4px);
            margin-left: auto;
        }
        .sidebar {
            position: fixed; 
            right: -260px; 
            top: 0; 
            width: 240px; 
            height: 100%;
            background: white; 
            box-shadow: -5px 0 25px rgba(0,0,0,0.15);
            transition: 0.3s cubic-bezier(0.2, 0.9, 0.3, 1); 
            z-index: 1000;
            padding: 20px 12px 70px;
            border-radius: 30px 0 0 30px;
            overflow-y: auto;
        }
        .sidebar.open { right: 0; }
        .sidebar-item {
            padding: 12px 15px; 
            margin-bottom: 8px; 
            border-radius: 16px;
            display: flex; 
            align-items: center; 
            gap: 12px;
            cursor: pointer; 
            font-weight: 700; 
            color: #1e293b;
            font-size: 15px; 
            transition: 0.2s;
        }
        .sidebar-item:hover { background: #ede9fe; color: var(--primary-blue); }
        .sidebar-icon {
            font-size: 24px;
            width: 30px;
            text-align: center;
        }
        .sidebar-overlay {
            position: fixed; top:0; left:0; width:100%; height:100%;
            background: rgba(0,0,0,0.4); display:none; z-index: 999;
            backdrop-filter: blur(3px);
        }
        .sidebar-divider {
            height: 1px;
            background: #e0e0e0;
            margin: 15px 0;
        }
        .container {
            flex: 1; overflow-y: auto; padding: 15px 15px 40px;
            scroll-behavior: smooth;
        }
        .card {
            background: white; border-radius: 24px; padding: 16px 14px;
            box-shadow: 0 6px 18px rgba(0,0,0,0.04); margin-bottom: 16px;
            border: 1px solid rgba(255,255,255,0.6);
        }
        .stats-row {
            display: flex;
            justify-content: space-between;
            gap: 8px;
            margin-bottom: 12px;
        }
        .stat-item {
            flex: 1;
            background: #f8fafc;
            border-radius: 20px;
            padding: 10px 3px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.02);
            border: 1px solid #eef2f6;
        }
        .stat-label {
            font-size: 13px;
            color: #64748b;
            font-weight: 600;
        }
        .stat-value {
            font-size: 20px;
            font-weight: 900;
            line-height: 1.2;
        }
        .stat-value.total { color: var(--primary-blue); }
        .stat-value.paid { color: var(--success-green); }
        .stat-value.remaining { color: #f97316; }
        input, select {
            width: 100%; padding: 12px 14px; margin-bottom: 10px;
            border: 2px solid #e9eef2; border-radius: 18px;
            font-family: 'Cairo'; font-size: 15px; background: #fafcff;
            outline: none; transition: 0.15s;
        }
        input:focus, select:focus { border-color: var(--primary-blue); background: white; }
        .btn {
            border: none; border-radius: 18px; font-family: 'Cairo';
            font-weight: 800; cursor: pointer; padding: 12px 10px;
            width: 100%; font-size: 15px; transition: 0.2s;
        }
        .btn:active { transform: scale(0.97); }
        .btn-blue { background: var(--primary-blue); color: white; box-shadow: 0 5px 0 #2a23b5; }
        .btn-blue:active { box-shadow: 0 2px 0 #2a23b5; transform: translateY(3px); }
        .btn-update {
            background: #2563eb; color: white; display: none;
            box-shadow: 0 5px 0 #1e3f8f;
        }
        table {
            width: 100%; border-collapse: collapse; background: white;
            border-radius: 20px; overflow: hidden; margin-top:8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.03);
        }
        th {
            background: #f2f5fe; padding: 10px 3px; font-size: 12px;
            color: #1e293b; font-weight: 800;
        }
        td {
            padding: 12px 3px; text-align: center; border-bottom: 1px solid #ecf1f6;
            font-weight: 700; font-size: 15px;
        }
        .clickable-amt {
            color: var(--primary-blue); cursor: pointer;
            text-decoration: underline dotted; font-weight: 900;
        }
        .over-limit-row { background-color: #ffeff0; color: var(--dark-red); font-weight: 800; }
        .unknown-row { background-color: #f0f4ff; color: var(--primary-blue); font-weight: 800; }
        .page { display: none; }
        .page.active { display: block; }
        #lockMsgDebt {
            display: none; color: var(--dark-red); font-weight: 800;
            background: #fff0f0; padding: 12px; border-radius: 20px;
            text-align: center; border: 2px dashed #e11d48; margin-bottom: 15px;
        }
        .btn-del {
            background: #fee2e2; color: #b91c1c; border: none;
            border-radius: 40px; padding: 6px 12px; font-weight: 800;
            cursor: pointer;
        }
        .grand-total {
            font-size: 28px; font-weight: 900; color: var(--primary-blue);
            line-height: 1.2;
        }
        hr { border: 1px solid #eef2f6; margin: 14px 0; }
        .total-box {
            background: #f0f4ff;
            border-radius: 20px;
            padding: 12px;
            text-align: center;
        }
        .total-label {
            font-size: 15px;
            color: #475569;
            font-weight: 700;
        }
        .total-value {
            font-size: 32px;
            font-weight: 900;
        }
        /* Ø£Ù†Ù…Ø§Ø· Ø§Ù„ØµÙÙˆÙ Ù„Ù„Ø¹Ù…Ù„ÙŠØ§Øª */
        tr.purchase-with-details {
            background-color: #e6f7e6 !important;
        }
        tr.purchase-with-details td {
            color: #0a5c0a;
            font-weight: 800;
        }
        tr.purchase-no-details {
            background-color: white;
        }
        tr.payment-row {
            background-color: #f0f0f0;
        }
        /* Ø£Ù†Ù…Ø§Ø· Ø§Ù„Ø£Ø²ÙˆØ§Ø¬ Ø§Ù„Ù…Ø³Ø¯Ø¯Ø© */
        tbody.settled-pair {
            display: table-row-group;
            border: 1px solid #ccc;
            border-radius: 8px;
            margin-bottom: 8px;
            background-color: #ffcccc;
        }
        tbody.settled-pair tr {
            font-size: 12px;
        }
        tbody.settled-pair td {
            padding: 6px 3px;
        }
        tr.settled-purchase {
            background-color: #ffcccc !important;
        }
        tr.settled-purchase td {
            color: #8b0000 !important;
            font-weight: 900;
        }
        tr.settled-payment {
            background-color: #ffcccc !important;
        }
        tr.settled-payment td {
            color: #8b0000 !important;
            font-weight: 900;
        }
        /* Ø¹Ù…ÙˆØ¯ checkbox */
        .checkbox-column {
            width: 40px;
            text-align: center;
        }
        .checkbox-column input {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
        .store-name-badge {
            background: #f97316;
            color: white;
            padding: 3px 10px;
            border-radius: 30px;
            font-size: 13px;
            display: inline-block;
            margin-bottom: 8px;
        }
        .home-header {
            text-align: center;
            margin-bottom: 15px;
        }
        .chart-container {
            background: white;
            border-radius: 24px;
            padding: 15px;
            box-shadow: var(--shadow);
            margin-bottom: 15px;
        }
        canvas {
            max-height: 300px;
            width: 100% !important;
        }
        .install-prompt {
            background: white;
            border-radius: 20px;
            padding: 12px 15px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border: 2px solid var(--primary-blue);
        }
        .install-btn {
            background: var(--primary-blue);
            color: white;
            border: none;
            border-radius: 40px;
            padding: 8px 16px;
            font-weight: 700;
            cursor: pointer;
        }
        .auto-save-indicator {
            display: inline-block;
            background: rgba(255,255,255,0.2);
            border-radius: 40px;
            padding: 2px 8px;
            font-size: 10px;
            margin-right: 5px;
            vertical-align: middle;
            transition: opacity 0.2s;
        }
        .status-message {
            text-align: center;
            padding: 20px;
            border-radius: 30px;
            font-size: 28px;
            font-weight: 900;
            margin-top: 20px;
            box-shadow: var(--shadow);
        }
        .status-positive {
            background-color: #d4edda;
            color: #155724;
            border: 3px solid #28a745;
        }
        .status-negative {
            background-color: #f8d7da;
            color: #721c24;
            border: 3px solid #dc3545;
        }
        .status-neutral {
            background-color: #fff3cd;
            color: #856404;
            border: 3px solid #ffc107;
        }
        .status-emoji {
            font-size: 60px;
            display: block;
            margin-bottom: 10px;
        }
        @media print {
            body * {
                visibility: hidden;
            }
            .print-area, .print-area * {
                visibility: visible;
            }
            .print-area {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                padding: 20px;
                background: white;
                font-family: 'Cairo', sans-serif;
            }
            .print-area table {
                width: 100%;
                border-collapse: collapse;
                margin-top: 20px;
            }
            .print-area th {
                background: #f2f5fe;
                padding: 10px;
                font-size: 14px;
            }
            .print-area td {
                padding: 8px;
                border: 1px solid #ddd;
            }
            .print-title {
                font-size: 24px;
                font-weight: 900;
                text-align: center;
                color: var(--primary-blue);
                margin-bottom: 5px;
            }
            .print-subtitle {
                text-align: center;
                font-size: 18px;
                margin-bottom: 20px;
            }
        }
        .payment-options {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        .payment-option-btn {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 18px;
            font-family: 'Cairo';
            font-weight: 700;
            cursor: pointer;
            transition: 0.2s;
        }
        .payment-option-btn:active {
            transform: scale(0.95);
        }
        .payment-from-borrow {
            background: #0284c7;
            color: white;
            box-shadow: 0 3px 0 #075985;
        }
        .payment-from-savings {
            background: #10b981;
            color: white;
            box-shadow: 0 3px 0 #0b7e5a;
        }
        /* ØªÙ†Ø³ÙŠÙ‚ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø¬Ø§Ù…ÙŠØ¹ */
        .totals-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        .totals-table th {
            background: #f2f5fe;
            padding: 12px 5px;
            font-size: 14px;
            color: #1e293b;
            font-weight: 800;
        }
        .totals-table td {
            padding: 12px 5px;
            text-align: center;
            border-bottom: 1px solid #ecf1f6;
            font-weight: 700;
            font-size: 16px;
        }
        .row-savings td:first-child {
            color: #10b981;
            font-weight: 900;
        }
        .row-borrow td:first-child {
            color: #0284c7;
            font-weight: 900;
        }
        .row-purchases td:first-child {
            color: #f97316;
            font-weight: 900;
        }
        .row-paid-detail {
            font-size: 14px;
            color: #6c757d;
        }
        .row-paid-detail td:first-child {
            padding-right: 30px;
        }
        .net-row {
            background-color: #f0f4ff;
            font-weight: 900;
        }
        .net-row td {
            padding: 15px 5px;
        }
        .positive {
            color: var(--success-green);
        }
        .negative {
            color: var(--danger-red);
        }
        /* ØªÙ†Ø³ÙŠÙ‚ Ø¬Ø¯ÙˆÙ„ Ø§Ù„ØªØ¬Ø§Ø± */
        .stores-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        .stores-table th {
            background: #f97316;
            color: white;
            padding: 10px 5px;
            font-size: 13px;
        }
        .stores-table td {
            padding: 10px 5px;
            text-align: center;
            border-bottom: 1px solid #ecf1f6;
        }
    </style>
</head>
<body>
<!-- Ù†ÙØ³ Ù‡ÙŠÙƒÙ„ HTML Ø§Ù„Ø³Ø§Ø¨Ù‚ (Ù„Ù… ÙŠØªØºÙŠØ±) -->
<div class="sidebar-overlay" id="overlay" onclick="toggleSidebar()"></div>
<div class="sidebar" id="sidebar">
    <div style="display: flex; flex-direction: column; height: 100%;">
        <div style="text-align:center; margin: 10px 0 20px;">
            <span style="font-size: 48px;">ğŸ’°</span>
            <h3 style="color: var(--primary-blue); margin:5px 0 0; font-size:18px;">Ø§Ù„Ù…Ø³ØªÙ‚Ø± Ø§Ù„Ù…Ø§Ù„ÙŠ</h3>
            <span class="auto-save-indicator">âœ“ Ø­ÙØ¸ ØªÙ„Ù‚Ø§Ø¦ÙŠ</span>
        </div>
        
        <div class="sidebar-item" onclick="showPage('tabHomepage')">
            <span class="sidebar-icon">ğŸ </span>
            <span>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span>
        </div>
        <div class="sidebar-item" onclick="showPage('tabBorrow')">
            <span class="sidebar-icon">ğŸ’¸</span>
            <span>Ø§Ù„Ø³Ù„Ù (Ø¹Ù„ÙŠ)</span>
        </div>
        <div class="sidebar-item" onclick="showPage('tabDebtHome')">
            <span class="sidebar-icon">ğŸ›’</span>
            <span>Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª Ø¨Ø§Ù„Ø¯ÙŠÙ†</span>
        </div>
        <div class="sidebar-item" onclick="showPage('tabSave')">
            <span class="sidebar-icon">ğŸ’°</span>
            <span>Ø§Ù„Ø§Ø¯Ø®Ø§Ø±</span>
        </div>
        <div class="sidebar-item" onclick="showPage('tabSovereignSavings')">
            <span class="sidebar-icon">ğŸ¦</span>
            <span>Ø§Ù„Ø§Ø¯Ø®Ø§Ø± Ø§Ù„Ø³ÙŠØ§Ø¯ÙŠ</span>
        </div>
        <div class="sidebar-item" onclick="showPage('tabTotals')">
            <span class="sidebar-icon">ğŸ“Š</span>
            <span>Ø§Ù„Ù…Ø¬Ø§Ù…ÙŠØ¹</span>
        </div>
        
        <div class="sidebar-divider"></div>
        
        <div class="sidebar-item" onclick="exportData()">
            <span class="sidebar-icon">ğŸ“¤</span>
            <span>ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</span>
        </div>
        <div class="sidebar-item" onclick="document.getElementById('importFile').click()">
            <span class="sidebar-icon">ğŸ“¥</span>
            <span>Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</span>
        </div>
        <input type="file" id="importFile" accept=".json,application/json" style="display: none;" onchange="importData(event)">
        
        <div style="flex:1;"></div>
        
        <div style="font-size:12px; color:#aaa; text-align:center; padding:10px;">
            <span style="font-size:10px;">Ø£Ø¶Ù Ù„Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø³Ø±ÙŠØ¹</span>
        </div>
    </div>
</div>

<div class="app-header">
    <div class="fixed-title">
        <span>ğŸ’°</span> Ù…Ù†ØµØ© Ø§Ù„Ø§Ø³ØªÙ‚Ø±Ø§Ø± Ø§Ù„Ù…Ø§Ù„ÙŠ ÙˆØ§Ù„Ø§Ø¯Ø®Ø§Ø±ÙŠ
        <span class="auto-save-indicator">âœ“ Ø­ÙØ¸ ØªÙ„Ù‚Ø§Ø¦ÙŠ</span>
    </div>
    
    <div class="second-row">
        <div class="menu-btn" onclick="toggleSidebar()">â˜°</div>
        <div id="dynamicTitle" class="dynamic-title">
            <span>ğŸ </span> Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Â· Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ
        </div>
        <button id="btnBack" class="back-btn" onclick="goBack()">â†© Ø±Ø¬ÙˆØ¹</button>
    </div>
</div>

<div id="installMessage" style="display: none;" class="install-prompt">
    <span>ğŸ“± Ø«Ø¨Øª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¹Ù„Ù‰ Ù‡Ø§ØªÙÙƒ Ù„Ù„ÙˆØµÙˆÙ„ Ø§Ù„Ø³Ø±ÙŠØ¹</span>
    <button id="installBtn" class="install-btn">ØªØ«Ø¨ÙŠØª</button>
</div>

<div class="container">
    <!-- Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© -->
    <div id="tabHomepage" class="page active">
        <div class="home-header">
            <h2 style="font-size: 22px; font-weight: 900; color: var(--primary-blue); margin:0;">ğŸ“Š Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø§Ù„ÙŠ Ø§Ù„Ø­Ø§Ù„ÙŠ</h2>
        </div>
        <div class="chart-container">
            <canvas id="financialChart"></canvas>
        </div>
        <div id="statusMessage" class="status-message"></div>
    </div>

    <!-- Ø§Ù„Ø³Ù„Ù (Ø¹Ù„ÙŠ) -->
    <div id="tabBorrow" class="page">
        <div class="card" style="background: linear-gradient(145deg, #f0f9ff, #fff);">
            <h3 style="margin:0 0 8px; display:flex; align-items:center; gap:6px; font-size:18px;">
                <span style="font-size:24px;">ğŸ’¸</span> Ø§Ù„Ø³Ù„Ù (Ø¹Ù„ÙŠ) ğŸ‘ˆ Ø§Ø³ØªÙ„ÙØª Ù…Ù† Ù†Ø§Ø³
            </h3>
            <p style="color:#64748b; font-size:13px; margin-top:-3px;">Ø£Ø´Ø®Ø§Øµ Ø£Ù‚Ø±Ø¶ÙˆÙ†ÙŠ Ù…Ø§Ù„Ø§Ù‹ (Ø³Ù„ÙØ© Ù†Ù‚Ø¯ÙŠØ©)</p>
            <input type="text" id="bName" placeholder="Ø§Ø³Ù… Ø§Ù„Ø´Ø®Øµ (Ø§Ù„Ø¯Ø§Ø¦Ù†)">
            <input type="number" id="bAmt" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø³ØªÙ„Ù (Ø¹Ù„ÙŠ)">
            <button class="btn" style="background:#0284c7; color:white; box-shadow:0 4px 0 #075985;" onclick="addBorrow()">â• ØªØ³Ø¬ÙŠÙ„ Ø³Ù„ÙØ© Ø¬Ø¯ÙŠØ¯Ø©</button>
        </div>
        <table>
            <thead>
                <tr>
                    <th>Ø§Ù„Ø´Ø®Øµ</th>
                    <th>Ø§Ù„Ù…Ø¨Ù„Øº (Ø¹Ù„ÙŠ)</th>
                    <th>Ø§Ù„Ù…Ø³ØªÙ‡Ù„Ùƒ ğŸ’¸</th>
                    <th>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</th>
                    <th>Ø­Ø°Ù</th>
                </tr>
            </thead>
            <tbody id="borrowTable"></tbody>
        </table>
    </div>

    <!-- Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª Ø¨Ø§Ù„Ø¯ÙŠÙ† (Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØªØ¬Ø§Ø±) -->
    <div id="tabDebtHome" class="page">
        <div class="card" style="text-align: center; background: linear-gradient(145deg, #fff7ed, #fff);">
            <small style="opacity:0.7;">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª Ø¨Ø§Ù„Ø¯ÙŠÙ† (Ø¹Ù„ÙŠ) ğŸ‘ˆ Ø¹Ù„ÙŠ Ù„Ù„ØªØ¬Ø§Ø±</small>
            <div id="grandDebtOwed" class="grand-total" style="color:#f97316;">0 Ø¯Ø¬</div>
        </div>
        <div class="card" style="background:#fff7ed;">
            <input type="text" id="storeName" placeholder="Ø§Ø³Ù… Ø§Ù„ØªØ§Ø¬Ø± / Ø§Ù„Ù…Ø­Ù„ (Ø¹Ù„ÙŠ Ø¯ÙŠÙ†)">
            <input type="number" id="storeInit" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø£ÙˆÙ„ÙŠ (Ø¹Ù„ÙŠ)">
            <button class="btn" style="background:#f97316; color:white; box-shadow:0 4px 0 #c2410c;" onclick="addStore()">â• Ø¥Ø¶Ø§ÙØ© ØªØ§Ø¬Ø± (Ø¹Ù„ÙŠ Ø¯ÙŠÙ†)</button>
        </div>
        
        <table class="stores-table">
            <thead>
                <tr>
                    <th>Ø§Ø³Ù… Ø§Ù„ØªØ§Ø¬Ø±</th>
                    <th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨Ù„Øº</th>
                    <th>Ø§Ù„Ù…Ø¯ÙÙˆØ¹</th>
                    <th>Ø§Ù„Ø¨Ø§Ù‚ÙŠ</th>
                    <th>Ø­Ø°Ù</th>
                </tr>
            </thead>
            <tbody id="storesTableBody"></tbody>
        </table>
    </div>

    <!-- ØµÙØ­Ø© Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª (Ù„ÙƒÙ„ ØªØ§Ø¬Ø±) -->
    <div id="tabDebtOps" class="page">
        <div class="card" style="padding: 14px; background:#fff7ed;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <div class="store-name-badge" id="currentStoreName"></div>
                <div style="display: flex; gap: 5px;">
                    <button class="btn" style="width: auto; padding: 6px 12px; background: #2563eb; color: white; box-shadow: 0 3px 0 #1e3f8f;" onclick="printStoreStatement()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button>
                    <button class="btn" style="width: auto; padding: 6px 12px; background: #6c757d; color: white; box-shadow: 0 3px 0 #545b62;" onclick="showPaidRecords()">ğŸ“œ Ø³Ø¬Ù„ Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª</button>
                </div>
            </div>
            <div class="stats-row">
                <div class="stat-item">
                    <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª</div>
                    <div class="stat-value total" id="debtStatsTotal">0</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Ù…Ø¯ÙÙˆØ¹ Ù„Ù„ØªØ§Ø¬Ø±</div>
                    <div class="stat-value paid" id="debtStatsPaid">0</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ø¹Ù„ÙŠ</div>
                    <div class="stat-value remaining" id="debtStatsRemaining">0</div>
                </div>
            </div>
        </div>
        <div class="card" style="background:#fff7ed;">
            <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                <input type="date" id="debtODate" style="flex:2; min-width:120px;">
                <input type="number" id="debtOAmt" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº" style="flex:1;">
            </div>
            <div id="debtNormalBtns" style="display: flex; gap: 10px; margin-top:8px;">
                <button class="btn" style="background:#f59e0b; color:white; font-weight:800; flex:1; box-shadow:0 4px 0 #b45309; font-size:14px; padding:10px;" onclick="addDebtOp('Ù…Ø´ØªØ±ÙŠØ§Øª')">â• Ù…Ø´ØªØ±ÙŠØ§Øª Ø¬Ø¯ÙŠØ¯Ø©</button>
                <button class="btn" style="background:var(--success-green); color:white; flex:1; box-shadow:0 4px 0 #0b7e5a; font-size:14px; padding:10px;" onclick="showPaymentOptions()">ğŸ’° Ø¯ÙØ¹ ÙˆØªØ³Ø¯ÙŠØ¯</button>
            </div>
            
            <div id="paymentOptions" style="display: none; margin-top: 10px;">
                <div class="payment-options">
                    <button class="payment-option-btn payment-from-borrow" onclick="processPaymentFromSource('borrow')">ğŸ’¸ Ø¯ÙØ¹ Ù…Ù† Ø§Ù„Ø³Ù„Ù</button>
                    <button class="payment-option-btn payment-from-savings" onclick="processPaymentFromSource('savings')">ğŸ’° Ø¯ÙØ¹ Ù…Ù† Ø§Ù„Ø§Ø¯Ø®Ø§Ø±</button>
                </div>
                <button class="btn" style="background:#6c757d; color:white; margin-top:5px; padding:8px;" onclick="hidePaymentOptions()">Ø¥Ù„ØºØ§Ø¡</button>
            </div>
            
            <button id="debtUpdateBtn" class="btn btn-update" onclick="confirmDebtUpdate()" style="padding:10px;">âœ… ØªØ£ÙƒÙŠØ¯ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø¨Ù„Øº</button>
        </div>
        <table>
            <thead><tr><th class="checkbox-column"></th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th><th>Ù†ÙˆØ¹</th><th>ØªÙØ§ØµÙŠÙ„</th><th>Ø­Ø°Ù</th></tr></thead>
            <tbody id="debtOpsTable"></tbody>
        </table>
    </div>

    <!-- ØµÙØ­Ø© Ø³Ø¬Ù„ Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª (Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ù…Ø³Ø¯Ø¯Ø©) -->
    <div id="tabDebtPaid" class="page">
        <div class="card" style="background:#fff7ed;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <div class="store-name-badge" id="currentStoreNamePaid"></div>
                <button class="btn" style="width: auto; padding: 6px 12px; background: #6c757d; color: white; box-shadow: 0 3px 0 #545b62;" onclick="goBackToOps()">ğŸ”™ Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø¹Ù…Ù„ÙŠØ§Øª</button>
            </div>
            <h3 style="margin:0 0 10px; text-align: center;">ğŸ“œ Ø³Ø¬Ù„ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø©</h3>
        </div>
        <table style="border-collapse: separate; border-spacing: 0 5px;">
            <thead><tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th><th>Ù†ÙˆØ¹</th><th>ØªÙØ§ØµÙŠÙ„</th><th>Ø§Ù„Ù…ØµØ¯Ø±</th><th>Ø­Ø°Ù</th></tr></thead>
            <tbody id="debtPaidTable"></tbody>
        </table>
    </div>

    <!-- ØµÙØ­Ø© ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø³Ù„Ø¹ Ù„Ù„Ù…Ø´ØªØ±ÙŠØ§Øª -->
    <div id="tabDebtDet" class="page">
        <div class="card" style="background:#fff7ed;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <div class="store-name-badge" id="currentStoreNameDet"></div>
                <button class="btn" style="width: auto; padding: 6px 12px; background: #2563eb; color: white; box-shadow: 0 3px 0 #1e3f8f;" onclick="printDebtDetails()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button>
            </div>
            <div id="lockMsgDebt">âš ï¸ ØªÙ… ØªØ¬Ø§ÙˆØ² Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø£ØµÙ„ÙŠ! ÙŠØ¬Ø¨ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø£ÙˆÙ„Ø§Ù‹.</div>
            <div id="debtDetForm">
                <input type="text" id="debtDItem" placeholder="Ø§Ø³Ù… Ø§Ù„Ø³Ù„Ø¹Ø©">
                <div style="display:flex; gap:8px;">
                    <input type="number" id="debtDQty" placeholder="Ø§Ù„ÙƒÙ…ÙŠØ©" value="1">
                    <input type="number" id="debtDPrc" placeholder="Ø§Ù„Ø³Ø¹Ø±">
                </div>
                <button class="btn" style="background:#f97316; color:white; box-shadow:0 4px 0 #c2410c;" onclick="addDebtDet()">â• Ø¥Ø¶Ø§ÙØ© Ø³Ù„Ø¹Ø©</button>
            </div>
        </div>
        <table>
            <thead><tr style="background:#f97316; color:white;"><th>Ø§Ù„Ø³Ù„Ø¹Ø©</th><th>Ø§Ù„ÙƒÙ…ÙŠØ©</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th><th>Ø¥Ø²Ø§Ù„Ø©</th></tr></thead>
            <tbody id="debtDetTable"></tbody>
        </table>
    </div>

    <!-- Ø§Ù„Ø§Ø¯Ø®Ø§Ø± Ø§Ù„Ø¹Ø§Ø¯ÙŠ -->
    <div id="tabSave" class="page">
        <div class="card">
            <h3 style="margin:0 0 8px; font-size:18px;">ğŸ’° Ø§Ù„Ø§Ø¯Ø®Ø§Ø± Ø§Ù„Ø´Ø®ØµÙŠ</h3>
            <input type="text" id="sPlace" placeholder="Ø§Ù„Ù…ÙƒØ§Ù† / Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚">
            <input type="number" id="sAmt" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯Ø®Ø±">
            <button class="btn" style="background:var(--success-green); color:white; box-shadow:0 4px 0 #0b7e5a;" onclick="addSaving()">Ø¥ÙŠØ¯Ø§Ø¹ ÙÙŠ Ø§Ù„Ø§Ø¯Ø®Ø§Ø±</button>
        </div>
        <table>
            <thead>
                <tr>
                    <th>Ø§Ù„Ù…ÙƒØ§Ù†</th>
                    <th>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯Ø®Ø±</th>
                    <th>Ø§Ù„Ù…Ø³ØªÙ‡Ù„Ùƒ ğŸ’°</th>
                    <th>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</th>
                    <th>Ø­Ø°Ù</th>
                </tr>
            </thead>
            <tbody id="savingsTable"></tbody>
        </table>
    </div>

    <!-- ØµÙØ­Ø© Ø§Ù„Ø§Ø¯Ø®Ø§Ø± Ø§Ù„Ø³ÙŠØ§Ø¯ÙŠ (Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©) -->
    <div id="tabSovereignSavings" class="page">
        <div class="card">
            <h3 style="margin:0 0 8px; font-size:18px;">ğŸ¦ Ø§Ù„Ø§Ø¯Ø®Ø§Ø± Ø§Ù„Ø³ÙŠØ§Ø¯ÙŠ</h3>
            <p style="color:#64748b; font-size:13px;">Ø£Ø¯Ø®Ù„ Ù…Ø¨Ù„Øº Ø§Ù„Ø§Ø¯Ø®Ø§Ø± Ø§Ù„Ø³ÙŠØ§Ø¯ÙŠ ÙˆÙ†Ø³Ø¨Ø© Ø§Ù„Ø§Ø­ØªÙØ§Ø¸ (Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ ÙŠØ°Ù‡Ø¨ Ù„Ù„Ø§Ø¯Ø®Ø§Ø± Ø§Ù„Ø¹Ø§Ø¯ÙŠ)</p>
            <input type="month" id="ssMonth" placeholder="Ø§Ù„Ø´Ù‡Ø±">
            <input type="number" id="ssAmount" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº">
            <input type="number" id="ssRetention" placeholder="Ù†Ø³Ø¨Ø© Ø§Ù„Ø§Ø­ØªÙØ§Ø¸ (%)" min="0" max="100">
            <button class="btn" style="background:#6c757d; color:white; box-shadow:0 4px 0 #545b62;" onclick="addSovereignSaving()">â• Ø¥Ø¶Ø§ÙØ©</button>
        </div>
        <table>
            <thead>
                <tr>
                    <th>Ø§Ù„Ø´Ù‡Ø±</th>
                    <th>Ø§Ù„Ù…Ø¨Ù„Øº</th>
                    <th>Ù†Ø³Ø¨Ø© Ø§Ù„Ø§Ø­ØªÙØ§Ø¸</th>
                    <th>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø­ÙˆÙ„ Ù„Ù„Ø§Ø¯Ø®Ø§Ø±</th>
                    <th>Ø­Ø°Ù</th>
                </tr>
            </thead>
            <tbody id="sovereignTable"></tbody>
        </table>
    </div>

    <!-- Ø§Ù„Ù…Ø¬Ø§Ù…ÙŠØ¹ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© -->
    <div id="tabTotals" class="page">
        <div class="card" style="background:white;">
            <table class="totals-table">
                <thead>
                    <tr>
                        <th></th>
                        <th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
                        <th>Ø§Ù„Ù…Ø³ØªÙ‡Ù„Ùƒ</th>
                        <th>Ø§Ù„Ø¨Ø§Ù‚ÙŠ</th>
                    </tr>
                </thead>
                <tbody>
                    <tr class="row-savings">
                        <td>ğŸ’° Ø§Ù„Ø§Ø¯Ø®Ø§Ø±</td>
                        <td id="totSavingsTotal">0 Ø¯Ø¬</td>
                        <td id="totSavingsConsumed">0 Ø¯Ø¬</td>
                        <td id="totSavingsRemaining">0 Ø¯Ø¬</td>
                    </tr>
                    <tr class="row-borrow">
                        <td>ğŸ’¸ Ø§Ù„Ø³Ù„Ù</td>
                        <td id="totBorrowsTotal">0 Ø¯Ø¬</td>
                        <td id="totBorrowsConsumed">0 Ø¯Ø¬</td>
                        <td id="totBorrowsRemaining">0 Ø¯Ø¬</td>
                    </tr>
                    <tr class="row-purchases">
                        <td>ğŸ›’ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª Ø¨Ø§Ù„Ø¯ÙŠÙ†</td>
                        <td id="totPurchasesTotal">0 Ø¯Ø¬</td>
                        <td>-</td>
                        <td id="totPurchasesRemaining">0 Ø¯Ø¬</td>
                    </tr>
                    <!-- ØµÙ Ø¥Ø¶Ø§ÙÙŠ Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª Ø§Ù„ØªØ¬Ø§Ø± -->
                    <tr class="row-paid-detail">
                        <td>ğŸ’° Ù…Ø¯ÙÙˆØ¹Ø§Øª Ø§Ù„ØªØ¬Ø§Ø±</td>
                        <td id="totPaidToStores">0 Ø¯Ø¬</td>
                        <td></td>
                        <td></td>
                    </tr>
                </tbody>
            </table>

            <hr>

            <div style="display: flex; justify-content: space-around; margin-top: 15px;">
                <div style="text-align: center;">
                    <div style="font-weight: 700; color: #475569;">ØµØ§ÙÙŠ Ø§Ù„Ù…Ø³ØªÙ‡Ù„Ùƒ</div>
                    <div id="netConsumed" class="total-value" style="font-size: 28px;">0 Ø¯Ø¬</div>
                    <div style="font-size: 12px; color: #64748b;">(Ù…Ø¯ÙÙˆØ¹Ø§Øª Ø§Ù„ØªØ¬Ø§Ø± - Ø§Ø³ØªÙ‡Ù„Ø§Ùƒ Ø§Ù„Ø§Ø¯Ø®Ø§Ø± ÙˆØ§Ù„Ø³Ù„Ù)</div>
                </div>
                <div style="text-align: center;">
                    <div style="font-weight: 700; color: #475569;">ØµØ§ÙÙŠ Ø§Ù„Ø¨Ø§Ù‚ÙŠ</div>
                    <div id="netRemaining" class="total-value" style="font-size: 28px;">0 Ø¯Ø¬</div>
                    <div style="font-size: 12px; color: #64748b;">(Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ù…Ù† Ø§Ù„Ø§Ø¯Ø®Ø§Ø± - Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ù…Ù† Ø§Ù„Ø³Ù„Ù)</div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Ø³ÙƒØ±ÙŠØ¨Øª PWA -->
<script>
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('sw.js').catch(() => {});
    }
    const swScript = `
    self.addEventListener('install', e => {
        e.waitUntil(caches.open('finance-app').then(cache => 
            cache.addAll(['/', '/index.html', 'https://fonts.googleapis.com/css2?family=Cairo:wght@600;700;800&display=swap'])
        ));
    });
    self.addEventListener('fetch', e => {
        e.respondWith(caches.match(e.request).then(response => response || fetch(e.request)));
    });`;
    const blob = new Blob([swScript], { type: 'application/javascript' });
    const url = URL.createObjectURL(blob);
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register(url).catch(() => {});
    }
    
    let deferredPrompt;
    const installMessage = document.getElementById('installMessage');
    const installBtn = document.getElementById('installBtn');
    window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredPrompt = e;
        installMessage.style.display = 'flex';
    });
    installBtn.addEventListener('click', async () => {
        if (!deferredPrompt) return;
        deferredPrompt.prompt();
        const { outcome } = await deferredPrompt.userChoice;
        if (outcome === 'accepted') {
            installMessage.style.display = 'none';
        }
        deferredPrompt = null;
    });
</script>

<script>
    (function() {
        const STORAGE_KEY = "MY_STABLE_FINANCE_v36";
        
        let db = JSON.parse(localStorage.getItem(STORAGE_KEY)) || { 
            stores: {},
            borrows: [],      // ÙƒÙ„ Ø¹Ù†ØµØ±: { name, amount, consumed }
            savings: [],        // ÙƒÙ„ Ø¹Ù†ØµØ±: { place, amount, consumed }
            sovereignSavings: [] // ÙƒÙ„ Ø¹Ù†ØµØ±: { month, amount, retention, transferred }
        };

        let curStore = "";
        let curStoreIdx = null;
        let editStoreIdx = null;
        let selectedPurchaseIndices = []; // Ø§Ù„Ù…ØµÙÙˆÙØ© Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„ÙÙ‡Ø§Ø±Ø³ Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©
        let pageStack = ['tabHomepage'];
        let financialChart = null;

        window.toggleSidebar = function() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('overlay');
            sidebar.classList.toggle('open');
            overlay.style.display = sidebar.classList.contains('open') ? 'block' : 'none';
        };

        function saveToStorage() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(db));
            const indicators = document.querySelectorAll('.auto-save-indicator');
            indicators.forEach(el => {
                el.style.opacity = '0.5';
                setTimeout(() => el.style.opacity = '1', 100);
            });
        }

        function updateDynamicTitle(icon, text) {
            document.getElementById('dynamicTitle').innerHTML = `<span>${icon}</span> ${text}`;
        }

        window.showPage = function(id, push = true) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            if (push && pageStack[pageStack.length - 1] !== id) pageStack.push(id);
            
            const backBtn = document.getElementById('btnBack');
            if (id === 'tabHomepage' || id === 'tabBorrow' || id === 'tabDebtHome') {
                backBtn.style.display = 'none';
            } else {
                backBtn.style.display = 'block';
            }

            if (id === 'tabHomepage') { 
                updateDynamicTitle('ğŸ ', 'Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Â· Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ');
                updateHomepageChart(); 
            }
            else if (id === 'tabBorrow') { 
                updateDynamicTitle('ğŸ’¸', 'Ø§Ù„Ø³Ù„Ù (Ø¹Ù„ÙŠ) Â· Ø§Ø³ØªÙ„ÙØª Ù…Ù† Ù†Ø§Ø³');
                renderBorrows(); 
            }
            else if (id === 'tabDebtHome') { 
                updateDynamicTitle('ğŸ›’', 'Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª Ø¨Ø§Ù„Ø¯ÙŠÙ† Â· Ø¹Ù„ÙŠ Ù„Ù„ØªØ¬Ø§Ø±');
                renderStoresTable(); 
            }
            else if (id === 'tabDebtOps') {
                updateDynamicTitle('ğŸ›’', `${curStore} Â· Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©`);
                document.getElementById('currentStoreName').innerText = curStore;
                renderDebtOps();
                updateDebtStats();
            }
            else if (id === 'tabDebtPaid') {
                updateDynamicTitle('ğŸ“œ', `${curStore} Â· Ø³Ø¬Ù„ Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª`);
                document.getElementById('currentStoreNamePaid').innerText = curStore;
                renderDebtPaid();
            }
            else if (id === 'tabDebtDet') {
                updateDynamicTitle('ğŸ“‹', 'ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª');
                document.getElementById('currentStoreNameDet').innerText = curStore;
                renderDebtDet();
            }
            else if (id === 'tabSave') { 
                updateDynamicTitle('ğŸ’°', 'Ø§Ù„Ø§Ø¯Ø®Ø§Ø± Ø§Ù„Ø´Ø®ØµÙŠ');
                renderSavings(); 
            }
            else if (id === 'tabSovereignSavings') { 
                updateDynamicTitle('ğŸ¦', 'Ø§Ù„Ø§Ø¯Ø®Ø§Ø± Ø§Ù„Ø³ÙŠØ§Ø¯ÙŠ');
                renderSovereignSavings(); 
            }
            else if (id === 'tabTotals') { 
                updateDynamicTitle('ğŸ“Š', 'Ø§Ù„Ù…Ø¬Ø§Ù…ÙŠØ¹ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©');
                calcFinal(); 
            }

            if (document.getElementById('sidebar').classList.contains('open')) window.toggleSidebar();
        };

        window.goBack = function() {
            if (pageStack.length > 1) {
                pageStack.pop();
                window.showPage(pageStack[pageStack.length - 1], false);
            }
        };

        // Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ù„Ø­Ø³Ø§Ø¨Ø§Øª
        function getTotalBorrows() {
            return db.borrows.reduce((acc, b) => acc + b.amount, 0);
        }
        function getTotalBorrowsConsumed() {
            return db.borrows.reduce((acc, b) => acc + (b.consumed || 0), 0);
        }
        function getTotalBorrowsRemaining() {
            return getTotalBorrows() - getTotalBorrowsConsumed();
        }
        function getTotalSavings() {
            return db.savings.reduce((acc, s) => acc + s.amount, 0);
        }
        function getTotalSavingsConsumed() {
            return db.savings.reduce((acc, s) => acc + (s.consumed || 0), 0);
        }
        function getTotalSavingsRemaining() {
            return getTotalSavings() - getTotalSavingsConsumed();
        }
        function getTotalStoreDebt() {
            let total = 0;
            for (let n in db.stores) {
                total += (db.stores[n].total - db.stores[n].paid);
            }
            return total;
        }
        function getTotalPaidToStores() {
            let total = 0;
            for (let n in db.stores) {
                total += db.stores[n].paid;
            }
            return total;
        }

        function updateStatusMessage() {
            const savingsRemaining = getTotalSavingsRemaining();
            const borrowsRemaining = getTotalBorrowsRemaining();
            const statusDiv = document.getElementById('statusMessage');
            let html = '';
            if (savingsRemaining > borrowsRemaining) {
                html = '<div class="status-message status-positive"><span class="status-emoji">ğŸ˜Š</span>Ø§Ù„ÙˆØ¶Ø¹ Ø¬ÙŠØ¯ (Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ù…Ù† Ø§Ù„Ø§Ø¯Ø®Ø§Ø± Ø£ÙƒØ¨Ø±)</div>';
            } else if (savingsRemaining < borrowsRemaining) {
                html = '<div class="status-message status-negative"><span class="status-emoji">ğŸ˜±</span>Ø§Ù„ÙˆØ¶Ø¹ Ø³ÙŠØ¡ - ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø­Ø°Ø± (Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ù…Ù† Ø§Ù„Ø³Ù„Ù Ø£ÙƒØ¨Ø±)</div>';
            } else {
                html = '<div class="status-message status-neutral"><span class="status-emoji">ğŸ˜</span>Ø§Ù„ÙˆØ¶Ø¹ Ù…ØªÙˆØ§Ø²Ù†</div>';
            }
            statusDiv.innerHTML = html;
        }

        function updateHomepageChart() {
            let totalBorrows = db.borrows.reduce((acc, b) => acc + b.amount, 0);
            let totalPurchases = getTotalStoreDebt();
            let totalSavings = db.savings.reduce((acc, s) => acc + s.amount, 0);

            const ctx = document.getElementById('financialChart').getContext('2d');
            
            if (financialChart) {
                financialChart.destroy();
            }

            financialChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Ø§Ù„Ø³Ù„Ù (Ø¹Ù„ÙŠ)', 'Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª Ø¨Ø§Ù„Ø¯ÙŠÙ†', 'Ø§Ù„Ø§Ø¯Ø®Ø§Ø±'],
                    datasets: [{
                        label: 'Ø§Ù„Ù…Ø¨Ù„Øº (Ø¯Ø¬)',
                        data: [totalBorrows, totalPurchases, totalSavings],
                        backgroundColor: ['#0284c7', '#f97316', '#10b981'],
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: { rtl: true, titleAlign: 'right', bodyAlign: 'right' }
                    },
                    scales: {
                        y: { beginAtZero: true, grid: { color: '#e9eef2' } }
                    }
                }
            });

            updateStatusMessage();
        }

        // ================ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø³Ù„Ù ================
        window.addBorrow = function() {
            let name = document.getElementById('bName').value.trim();
            let amt = parseFloat(document.getElementById('bAmt').value);
            if (!name || !amt) return alert("Ø§Ù…Ù„Ø£ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„");
            db.borrows.push({ name: name, amount: amt, consumed: 0 });
            saveToStorage();
            renderBorrows();
            document.getElementById('bName').value = '';
            document.getElementById('bAmt').value = '';
        };

        window.delBorrow = function(idx) {
            if (confirm(`Ø­Ø°Ù Ø§Ù„Ø³Ù„ÙØ© Ù…Ù† "${db.borrows[idx].name}"ØŸ`)) {
                db.borrows.splice(idx, 1);
                saveToStorage();
                renderBorrows();
            }
        };

        function renderBorrows() {
            let tbody = document.getElementById('borrowTable');
            tbody.innerHTML = '';
            db.borrows.forEach((entry, i) => {
                const remaining = entry.amount - (entry.consumed || 0);
                tbody.innerHTML += `<tr>
                    <td>${entry.name}</td>
                    <td>${entry.amount} Ø¯Ø¬</td>
                    <td class="clickable-amt" onclick="editBorrowConsumed(${i}, ${entry.consumed || 0})">${entry.consumed || 0} Ø¯Ø¬</td>
                    <td>${remaining} Ø¯Ø¬</td>
                    <td><span style="cursor:pointer; font-size:20px;" onclick="window.delBorrow(${i})">ğŸ—‘</span></td>
                </tr>`;
            });
        }

        window.editBorrowConsumed = function(idx, current) {
            const newVal = prompt("Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø³ØªÙ‡Ù„Ùƒ Ù…Ù† Ù‡Ø°Ù‡ Ø§Ù„Ø³Ù„ÙØ©:", current);
            if (newVal === null) return;
            const num = parseFloat(newVal);
            if (isNaN(num) || num < 0) return alert("Ù‚ÙŠÙ…Ø© ØºÙŠØ± ØµØ­ÙŠØ­Ø©");
            db.borrows[idx].consumed = num;
            saveToStorage();
            renderBorrows();
        };

        // ================ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø§Ø¯Ø®Ø§Ø± Ø§Ù„Ø¹Ø§Ø¯ÙŠ ================
        window.addSaving = function() {
            let place = document.getElementById('sPlace').value.trim();
            let amt = parseFloat(document.getElementById('sAmt').value);
            if (!place || !amt) return alert("Ø§Ù…Ù„Ø£ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„");
            db.savings.push({ place: place, amount: amt, consumed: 0 });
            saveToStorage();
            renderSavings();
            document.getElementById('sPlace').value = '';
            document.getElementById('sAmt').value = '';
        };

        window.delSaving = function(idx) {
            if (confirm(`Ø­Ø°Ù Ø§Ù„Ø§Ø¯Ø®Ø§Ø± "${db.savings[idx].place}"ØŸ`)) {
                db.savings.splice(idx, 1);
                saveToStorage();
                renderSavings();
            }
        };

        function renderSavings() {
            let tbody = document.getElementById('savingsTable');
            tbody.innerHTML = '';
            db.savings.forEach((entry, i) => {
                const remaining = entry.amount - (entry.consumed || 0);
                tbody.innerHTML += `<tr>
                    <td>${entry.place}</td>
                    <td>${entry.amount} Ø¯Ø¬</td>
                    <td class="clickable-amt" onclick="editSavingConsumed(${i}, ${entry.consumed || 0})">${entry.consumed || 0} Ø¯Ø¬</td>
                    <td>${remaining} Ø¯Ø¬</td>
                    <td><span style="cursor:pointer; font-size:20px;" onclick="window.delSaving(${i})">ğŸ—‘</span></td>
                </tr>`;
            });
        }

        window.editSavingConsumed = function(idx, current) {
            const newVal = prompt("Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø³ØªÙ‡Ù„Ùƒ Ù…Ù† Ù‡Ø°Ø§ Ø§Ù„Ø§Ø¯Ø®Ø§Ø±:", current);
            if (newVal === null) return;
            const num = parseFloat(newVal);
            if (isNaN(num) || num < 0) return alert("Ù‚ÙŠÙ…Ø© ØºÙŠØ± ØµØ­ÙŠØ­Ø©");
            db.savings[idx].consumed = num;
            saveToStorage();
            renderSavings();
        };

        // ================ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø§Ø¯Ø®Ø§Ø± Ø§Ù„Ø³ÙŠØ§Ø¯ÙŠ ================
        window.addSovereignSaving = function() {
            const month = document.getElementById('ssMonth').value;
            const amount = parseFloat(document.getElementById('ssAmount').value);
            const retention = parseFloat(document.getElementById('ssRetention').value);
            if (!month || !amount || amount <= 0 || isNaN(retention) || retention < 0 || retention > 100) {
                alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ù‚ÙŠÙ… ØµØ­ÙŠØ­Ø©");
                return;
            }
            const transferred = amount * (1 - retention / 100);
            // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø³ÙŠØ§Ø¯ÙŠ
            db.sovereignSavings.push({ month, amount, retention, transferred });
            // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø­ÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„Ø§Ø¯Ø®Ø§Ø± Ø§Ù„Ø¹Ø§Ø¯ÙŠ
            db.savings.push({ 
                place: `ØªØ­ÙˆÙŠÙ„ Ø³ÙŠØ§Ø¯ÙŠ ${month}`, 
                amount: transferred, 
                consumed: 0 
            });
            saveToStorage();
            renderSovereignSavings();
            renderSavings(); // ØªØ­Ø¯ÙŠØ« Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø§Ø¯Ø®Ø§Ø±
            // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø­Ù‚ÙˆÙ„
            document.getElementById('ssMonth').value = '';
            document.getElementById('ssAmount').value = '';
            document.getElementById('ssRetention').value = '';
        };

        window.renderSovereignSavings = function() {
            let tbody = document.getElementById('sovereignTable');
            tbody.innerHTML = '';
            db.sovereignSavings.forEach((entry, i) => {
                tbody.innerHTML += `<tr>
                    <td>${entry.month}</td>
                    <td>${entry.amount} Ø¯Ø¬</td>
                    <td>${entry.retention}%</td>
                    <td>${entry.transferred} Ø¯Ø¬</td>
                    <td><span style="cursor:pointer; font-size:20px;" onclick="delSovereign(${i})">ğŸ—‘</span></td>
                </tr>`;
            });
        };

        window.delSovereign = function(idx) {
            if (confirm("Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø³Ø¬Ù„ØŸ")) {
                // Ø­Ø°Ù Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø³ÙŠØ§Ø¯ÙŠ ÙÙ‚Ø· (Ù†ØªØ±Ùƒ Ø§Ù„Ø§Ø¯Ø®Ø§Ø± Ø§Ù„Ø¹Ø§Ø¯ÙŠ ÙƒÙ…Ø§ Ù‡Ùˆ)
                db.sovereignSavings.splice(idx, 1);
                saveToStorage();
                renderSovereignSavings();
            }
        };

        // ================ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª Ø¨Ø§Ù„Ø¯ÙŠÙ† ================
        window.addStore = function() {
            let name = document.getElementById('storeName').value.trim();
            let initAmount = parseFloat(document.getElementById('storeInit').value) || 0;
            if (!name) return alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„ØªØ§Ø¬Ø±");
            if (db.stores[name]) return alert("Ù‡Ø°Ø§ Ø§Ù„ØªØ§Ø¬Ø± Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ø§Ù‹");

            db.stores[name] = { total: initAmount, paid: 0, history: [] };
            if (initAmount > 0) {
                db.stores[name].history.push({ date: 'Ø¨Ø¯Ø§ÙŠØ©', amount: initAmount, type: 'Ù…Ø´ØªØ±ÙŠØ§Øª', details: [] });
            }
            saveToStorage();
            renderStoresTable();
            document.getElementById('storeName').value = '';
            document.getElementById('storeInit').value = '';
        };

        window.delStore = function(name) {
            if (confirm(`Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ§Ø¬Ø± "${name}"ØŸ`)) {
                delete db.stores[name];
                saveToStorage();
                renderStoresTable();
            }
        };

        // Ø¹Ø±Ø¶ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØªØ¬Ø§Ø± ÙÙŠ Ø¬Ø¯ÙˆÙ„
        function renderStoresTable() {
            let tbody = document.getElementById('storesTableBody');
            tbody.innerHTML = '';
            let totalDebt = 0;
            for (let name in db.stores) {
                let total = db.stores[name].total;
                let paid = db.stores[name].paid;
                let remaining = total - paid;
                totalDebt += remaining;
                tbody.innerHTML += `<tr onclick="openStoreOps('${name}')" style="cursor:pointer;">
                    <td>${name}</td>
                    <td>${total} Ø¯Ø¬</td>
                    <td>${paid} Ø¯Ø¬</td>
                    <td>${remaining} Ø¯Ø¬</td>
                    <td><button class="btn-del" onclick="event.stopPropagation(); window.delStore('${name}')">ğŸ—‘</button></td>
                </tr>`;
            }
            document.getElementById('grandDebtOwed').innerText = totalDebt + ' Ø¯Ø¬';
        }

        window.openStoreOps = function(name) {
            curStore = name;
            window.showPage('tabDebtOps');
        };

        // Ø¯ÙˆØ§Ù„ Ù„Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¨ÙŠÙ† ØµÙØ­Ø§Øª Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª
        window.showPaidRecords = function() {
            window.showPage('tabDebtPaid');
        };

        window.goBackToOps = function() {
            window.showPage('tabDebtOps');
        };

        // Ø¯ÙˆØ§Ù„ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØ­Ø¯ÙŠØ¯Ø§Øª
        window.toggleSelection = function(idx) {
            const pos = selectedPurchaseIndices.indexOf(idx);
            if (pos === -1) {
                selectedPurchaseIndices.push(idx);
            } else {
                selectedPurchaseIndices.splice(pos, 1);
            }
        };

        // Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª ØºÙŠØ± Ø§Ù„Ù…Ø³Ø¯Ø¯Ø© Ù…Ø¹ checkbox
        function renderDebtOps() {
            let history = db.stores[curStore].history || [];
            let tbody = document.getElementById('debtOpsTable');
            tbody.innerHTML = '';
            
            let settledPairs = [];
            let unsettledOps = [];
            
            for (let i = history.length - 1; i >= 0; i--) {
                let op = history[i];
                let idx = i;
                
                if (op.type === 'Ù…Ø´ØªØ±ÙŠØ§Øª') {
                    let isSettled = false;
                    for (let j = i + 1; j < history.length; j++) {
                        if (history[j].type === 'Ø¯ÙØ¹' && history[j].amount === op.amount) {
                            isSettled = true;
                            settledPairs.push({
                                purchase: { op, idx },
                                payment: { op: history[j], idx: j }
                            });
                            break;
                        }
                    }
                    if (!isSettled) {
                        unsettledOps.push({ op, idx, type: 'Ù…Ø´ØªØ±ÙŠØ§Øª' });
                    }
                } else if (op.type === 'Ø¯ÙØ¹') {
                    let isPartOfSettled = false;
                    for (let j = i - 1; j >= 0; j--) {
                        if (history[j].type === 'Ù…Ø´ØªØ±ÙŠØ§Øª' && history[j].amount === op.amount) {
                            isPartOfSettled = true;
                            break;
                        }
                    }
                    if (!isPartOfSettled) {
                        unsettledOps.push({ op, idx, type: 'Ø¯ÙØ¹' });
                    }
                }
            }
            
            for (let item of unsettledOps) {
                let op = item.op;
                let idx = item.idx;
                
                if (op.type === 'Ù…Ø´ØªØ±ÙŠØ§Øª') {
                    let hasDetails = op.details && op.details.length > 0;
                    let rowClass = hasDetails ? 'purchase-with-details' : 'purchase-no-details';
                    
                    tbody.innerHTML += `<tr class="${rowClass}">
                        <td class="checkbox-column"><input type="checkbox" class="purchase-checkbox" data-idx="${idx}" ${selectedPurchaseIndices.includes(idx) ? 'checked' : ''} onchange="toggleSelection(${idx})"></td>
                        <td>${op.date || 'Ø¨Ø¯ÙˆÙ† ØªØ§Ø±ÙŠØ®'}</td>
                        <td class="clickable-amt" onclick="window.startDebtEdit(${idx}, ${op.amount})">${op.amount}</td>
                        <td>â• Ù…Ø´ØªØ±ÙŠØ§Øª</td>
                        <td><button class="btn" style="padding:4px; width:30px; background:#fff7ed; font-size:14px;" onclick="window.openDebtDet(${idx})">ğŸ“‹</button></td>
                        <td><span style="cursor:pointer; font-size:20px;" onclick="window.delDebtOp(${idx})">ğŸ—‘</span></td>
                    </tr>`;
                } else {
                    let sourceIcon = '';
                    if (op.source === 'borrow') sourceIcon = 'ğŸ’¸';
                    else if (op.source === 'savings') sourceIcon = 'ğŸ’°';
                    
                    tbody.innerHTML += `<tr class="payment-row">
                        <td class="checkbox-column"></td>
                        <td>${op.date || 'Ø¨Ø¯ÙˆÙ† ØªØ§Ø±ÙŠØ®'}</td>
                        <td class="clickable-amt" onclick="window.startDebtEdit(${idx}, ${op.amount})">${op.amount}</td>
                        <td>ğŸ’° Ø¯ÙØ¹ ${sourceIcon ? 'Ù…Ù† ' + sourceIcon : ''}</td>
                        <td>â€”</td>
                        <td><span style="cursor:pointer; font-size:20px;" onclick="window.delDebtOp(${idx})">ğŸ—‘</span></td>
                    </tr>`;
                }
            }
        }

        // Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ù…Ø³Ø¯Ø¯Ø© ÙÙŠ tabDebtPaid Ù…Ø¹ Ø¥Ø·Ø§Ø±Ø§Øª ÙˆØ®Ø· 12px
        function renderDebtPaid() {
            let history = db.stores[curStore].history || [];
            let tbody = document.getElementById('debtPaidTable');
            tbody.innerHTML = '';
            
            let settledPairs = [];
            
            for (let i = history.length - 1; i >= 0; i--) {
                let op = history[i];
                let idx = i;
                
                if (op.type === 'Ù…Ø´ØªØ±ÙŠØ§Øª') {
                    for (let j = i + 1; j < history.length; j++) {
                        if (history[j].type === 'Ø¯ÙØ¹' && history[j].amount === op.amount) {
                            settledPairs.push({
                                purchase: { op, idx },
                                payment: { op: history[j], idx: j }
                            });
                            break;
                        }
                    }
                }
            }
            
            for (let pair of settledPairs) {
                let purchaseOp = pair.purchase.op;
                let purchaseIdx = pair.purchase.idx;
                let paymentOp = pair.payment.op;
                let paymentIdx = pair.payment.idx;
                let sourceIcon = '';
                if (paymentOp.source === 'borrow') sourceIcon = 'ğŸ’¸ Ù…Ù† Ø³Ù„Ù';
                else if (paymentOp.source === 'savings') sourceIcon = 'ğŸ’° Ù…Ù† Ø§Ø¯Ø®Ø§Ø±';
                
                // Ø¥Ù†Ø´Ø§Ø¡ tbody Ù…Ù†ÙØµÙ„ Ù„ÙƒÙ„ Ø²ÙˆØ¬
                tbody.innerHTML += `<tbody class="settled-pair" style="border: 1px solid #ccc; border-radius: 8px; display: table-row-group; margin-bottom: 5px;">
                    <tr class="settled-purchase">
                        <td>${purchaseOp.date || 'Ø¨Ø¯ÙˆÙ† ØªØ§Ø±ÙŠØ®'}</td>
                        <td>${purchaseOp.amount}</td>
                        <td>â• Ù…Ø´ØªØ±ÙŠØ§Øª (Ù…Ø³Ø¯Ø¯)</td>
                        <td><button class="btn" style="padding:4px; width:30px; background:#ffcccc; font-size:12px;" onclick="window.openDebtDet(${purchaseIdx})">ğŸ“‹</button></td>
                        <td>${sourceIcon}</td>
                        <td></td>
                    </tr>
                    <tr class="settled-payment">
                        <td>${paymentOp.date || 'Ø¨Ø¯ÙˆÙ† ØªØ§Ø±ÙŠØ®'}</td>
                        <td>${paymentOp.amount}</td>
                        <td>ğŸ’° Ø¯ÙØ¹ (Ù…Ø³Ø¯Ø¯)</td>
                        <td>â€”</td>
                        <td>${sourceIcon}</td>
                        <td><span style="cursor:pointer; font-size:14px; color: #b91c1c;" onclick="window.deletePayment(${paymentIdx}, ${purchaseIdx})">ğŸ—‘</span></td>
                    </tr>
                </tbody>`;
            }
            
            if (settledPairs.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù…Ù„ÙŠØ§Øª Ù…Ø³Ø¯Ø¯Ø©</td></tr>';
            }
        }

        // Ø¯Ø§Ù„Ø© Ø­Ø°Ù Ø§Ù„Ø¯ÙØ¹ ÙÙ‚Ø· (Ù…Ø¹ Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ù…Ø¨Ù„Øº Ø¥Ù„Ù‰ Ø§Ù„Ù…ØµØ¯Ø±)
        window.deletePayment = function(paymentIdx, purchaseIdx) {
            if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ù„ØºØ§Ø¡ Ù‡Ø°Ø§ Ø§Ù„Ø¯ÙØ¹ØŸ')) return;
            
            const store = db.stores[curStore];
            const paymentOp = store.history[paymentIdx];
            const purchaseOp = store.history[purchaseIdx];
            
            // Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ù…Ø¨Ù„Øº Ù…Ù† Ø§Ù„Ù…ØµØ¯Ø±
            if (paymentOp.source === 'borrow') {
                let remainingToReturn = paymentOp.amount;
                for (let i = 0; i < db.borrows.length; i++) {
                    const borrowConsumed = db.borrows[i].consumed || 0;
                    if (borrowConsumed > 0) {
                        const returnFromThis = Math.min(borrowConsumed, remainingToReturn);
                        db.borrows[i].consumed = borrowConsumed - returnFromThis;
                        remainingToReturn -= returnFromThis;
                        if (remainingToReturn <= 0) break;
                    }
                }
            } else if (paymentOp.source === 'savings') {
                let remainingToReturn = paymentOp.amount;
                for (let i = 0; i < db.savings.length; i++) {
                    const savingConsumed = db.savings[i].consumed || 0;
                    if (savingConsumed > 0) {
                        const returnFromThis = Math.min(savingConsumed, remainingToReturn);
                        db.savings[i].consumed = savingConsumed - returnFromThis;
                        remainingToReturn -= returnFromThis;
                        if (remainingToReturn <= 0) break;
                    }
                }
            }
            
            // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø¯ÙØ¹ ÙÙ‚Ø· Ù…Ù† history
            store.history.splice(paymentIdx, 1);
            
            // ØªØ­Ø¯ÙŠØ« Ø¥Ø¬Ù…Ø§Ù„ÙŠØ§Øª Ø§Ù„ØªØ§Ø¬Ø±
            store.paid -= paymentOp.amount;
            
            saveToStorage();
            renderBorrows();
            renderSavings();
            renderStoresTable(); // ØªØ­Ø¯ÙŠØ« Ø¬Ø¯ÙˆÙ„ Ø§Ù„ØªØ¬Ø§Ø±
            renderDebtPaid(); // Ø¥Ø¹Ø§Ø¯Ø© Ø¹Ø±Ø¶ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© (Ø³Ø¬Ù„ Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª)
        };

        function updateDebtStats() {
            if (!curStore || !db.stores[curStore]) return;
            let store = db.stores[curStore];
            let total = store.total || 0;
            let paid = store.paid || 0;
            let remaining = total - paid;

            document.getElementById('debtStatsTotal').innerText = total + ' Ø¯Ø¬';
            document.getElementById('debtStatsPaid').innerText = paid + ' Ø¯Ø¬';
            document.getElementById('debtStatsRemaining').innerText = remaining + ' Ø¯Ø¬';
        }

        // Ø¯Ø§Ù„Ø© Ø¥Ø¸Ù‡Ø§Ø± Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø¯ÙØ¹ (ØªØ³Ù…Ù‰ Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø²Ø± "Ø¯ÙØ¹ ÙˆØªØ³Ø¯ÙŠØ¯")
        window.showPaymentOptions = function() {
            document.getElementById('paymentOptions').style.display = 'block';
            document.getElementById('debtNormalBtns').style.display = 'none';
        };

        window.hidePaymentOptions = function() {
            document.getElementById('paymentOptions').style.display = 'none';
            document.getElementById('debtNormalBtns').style.display = 'flex';
        };

        // Ù‡Ø°Ù‡ Ø§Ù„Ø¯Ø§Ù„Ø© ØªÙØ³ØªØ¯Ø¹Ù‰ Ø¹Ù†Ø¯ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…ØµØ¯Ø± (Ø³Ù„Ù Ø£Ùˆ Ø§Ø¯Ø®Ø§Ø±) Ù…Ù† Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø¯ÙØ¹
        window.processPaymentFromSource = function(source) {
            if (selectedPurchaseIndices.length > 0) {
                // Ø¯ÙØ¹ Ø§Ù„Ù…Ø­Ø¯Ø¯
                processSelectedPayments(source);
            } else {
                // Ø¯ÙØ¹ Ø¹Ø§Ø¯ÙŠ Ø¨Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯Ø®Ù„
                processSinglePayment(source);
            }
            hidePaymentOptions();
        };

        // Ø¯ÙØ¹ Ø¹Ø§Ø¯ÙŠ (Ù…Ø¨Ù„Øº ÙˆØ§Ø­Ø¯)
        function processSinglePayment(source) {
            const amt = parseFloat(document.getElementById('debtOAmt').value);
            if (!amt || amt <= 0) {
                alert("Ø£Ø¯Ø®Ù„ Ù…Ø¨Ù„Øº ØµØ­ÙŠØ­ Ø£ÙˆÙ„Ø§Ù‹");
                return;
            }
            
            const date = document.getElementById('debtODate').value;
            const displayDate = date ? date.split('-').reverse().slice(0,2).join('/') : 'Ø§Ù„ÙŠÙˆÙ…';
            const store = db.stores[curStore];
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„Ù…Ø¨Ù„Øº Ù„Ø§ ÙŠØªØ¬Ø§ÙˆØ² Ø§Ù„Ø¯ÙŠÙ† Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ù„Ù„ØªØ§Ø¬Ø±
            const remainingDebt = store.total - store.paid;
            if (amt > remainingDebt) {
                alert(`Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ (${amt}) Ø£ÙƒØ¨Ø± Ù…Ù† Ø§Ù„Ø¯ÙŠÙ† Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ (${remainingDebt})!`);
                return;
            }
            
            if (source === 'borrow') {
                if (getTotalBorrowsRemaining() < amt) {
                    alert(`Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ (${amt}) Ø£ÙƒØ¨Ø± Ù…Ù† Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ ÙÙŠ Ø§Ù„Ø³Ù„Ù (${getTotalBorrowsRemaining()})!`);
                    return;
                }
                // Ø®ØµÙ… Ø§Ù„Ù…Ø¨Ù„Øº Ù…Ù† Ø§Ù„Ø³Ù„Ù
                let remainingToConsume = amt;
                for (let i = 0; i < db.borrows.length; i++) {
                    const borrowRemaining = db.borrows[i].amount - (db.borrows[i].consumed || 0);
                    if (borrowRemaining > 0) {
                        const consumeFromThis = Math.min(borrowRemaining, remainingToConsume);
                        db.borrows[i].consumed = (db.borrows[i].consumed || 0) + consumeFromThis;
                        remainingToConsume -= consumeFromThis;
                        if (remainingToConsume <= 0) break;
                    }
                }
                // Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ù…Ø¯ÙÙˆØ¹ Ù„Ù„ØªØ§Ø¬Ø±
                store.paid += amt;
                store.history.push({ 
                    date: displayDate, 
                    amount: amt, 
                    type: 'Ø¯ÙØ¹', 
                    source: 'borrow',
                    details: [] 
                });
                saveToStorage();
                renderBorrows();
            } else if (source === 'savings') {
                if (getTotalSavingsRemaining() < amt) {
                    alert(`Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ (${amt}) Ø£ÙƒØ¨Ø± Ù…Ù† Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ ÙÙŠ Ø§Ù„Ø§Ø¯Ø®Ø§Ø± (${getTotalSavingsRemaining()})!`);
                    return;
                }
                let remainingToConsume = amt;
                for (let i = 0; i < db.savings.length; i++) {
                    const savingRemaining = db.savings[i].amount - (db.savings[i].consumed || 0);
                    if (savingRemaining > 0) {
                        const consumeFromThis = Math.min(savingRemaining, remainingToConsume);
                        db.savings[i].consumed = (db.savings[i].consumed || 0) + consumeFromThis;
                        remainingToConsume -= consumeFromThis;
                        if (remainingToConsume <= 0) break;
                    }
                }
                store.paid += amt;
                store.history.push({ 
                    date: displayDate, 
                    amount: amt, 
                    type: 'Ø¯ÙØ¹', 
                    source: 'savings',
                    details: [] 
                });
                saveToStorage();
                renderSavings();
            }
            
            // Ø¥Ø¹Ø§Ø¯Ø© Ø±Ø³Ù… Ø§Ù„Ø¬Ø¯ÙˆÙ„ ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
            renderDebtOps();
            updateDebtStats();
            renderStoresTable(); // ØªØ­Ø¯ÙŠØ« Ø¬Ø¯ÙˆÙ„ Ø§Ù„ØªØ¬Ø§Ø±
            document.getElementById('debtOAmt').value = '';
        }

        // Ø¯ÙØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©
        function processSelectedPayments(source) {
            if (selectedPurchaseIndices.length === 0) return;

            const date = document.getElementById('debtODate').value;
            const displayDate = date ? date.split('-').reverse().slice(0,2).join('/') : 'Ø§Ù„ÙŠÙˆÙ…';
            const store = db.stores[curStore];

            // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù„Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©
            const totalAmount = selectedPurchaseIndices.reduce((sum, idx) => {
                return sum + store.history[idx].amount;
            }, 0);

            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù„Ø§ ÙŠØªØ¬Ø§ÙˆØ² Ø§Ù„Ø¯ÙŠÙ† Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ù„Ù„ØªØ§Ø¬Ø±
            const remainingDebt = store.total - store.paid;
            if (totalAmount > remainingDebt) {
                alert(`Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ (${totalAmount}) Ø£ÙƒØ¨Ø± Ù…Ù† Ø§Ù„Ø¯ÙŠÙ† Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ (${remainingDebt})!`);
                return;
            }

            if (source === 'borrow') {
                if (getTotalBorrowsRemaining() < totalAmount) {
                    alert(`Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ (${totalAmount}) Ø£ÙƒØ¨Ø± Ù…Ù† Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ ÙÙŠ Ø§Ù„Ø³Ù„Ù (${getTotalBorrowsRemaining()})!`);
                    return;
                }
                // Ø®ØµÙ… Ø§Ù„Ù…Ø¨Ù„Øº Ù…Ù† Ø§Ù„Ø³Ù„Ù
                let remainingToConsume = totalAmount;
                for (let i = 0; i < db.borrows.length; i++) {
                    const borrowRemaining = db.borrows[i].amount - (db.borrows[i].consumed || 0);
                    if (borrowRemaining > 0) {
                        const consumeFromThis = Math.min(borrowRemaining, remainingToConsume);
                        db.borrows[i].consumed = (db.borrows[i].consumed || 0) + consumeFromThis;
                        remainingToConsume -= consumeFromThis;
                        if (remainingToConsume <= 0) break;
                    }
                }
                // Ø¥Ù†Ø´Ø§Ø¡ Ø¯ÙØ¹Ø© Ù„ÙƒÙ„ Ø¹Ù…Ù„ÙŠØ© Ù…Ø­Ø¯Ø¯Ø©
                selectedPurchaseIndices.forEach(idx => {
                    const purchaseAmt = store.history[idx].amount;
                    store.paid += purchaseAmt;
                    store.history.push({
                        date: displayDate,
                        amount: purchaseAmt,
                        type: 'Ø¯ÙØ¹',
                        source: 'borrow',
                        details: []
                    });
                });
                saveToStorage();
                renderBorrows();
            } else if (source === 'savings') {
                if (getTotalSavingsRemaining() < totalAmount) {
                    alert(`Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ (${totalAmount}) Ø£ÙƒØ¨Ø± Ù…Ù† Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ ÙÙŠ Ø§Ù„Ø§Ø¯Ø®Ø§Ø± (${getTotalSavingsRemaining()})!`);
                    return;
                }
                let remainingToConsume = totalAmount;
                for (let i = 0; i < db.savings.length; i++) {
                    const savingRemaining = db.savings[i].amount - (db.savings[i].consumed || 0);
                    if (savingRemaining > 0) {
                        const consumeFromThis = Math.min(savingRemaining, remainingToConsume);
                        db.savings[i].consumed = (db.savings[i].consumed || 0) + consumeFromThis;
                        remainingToConsume -= consumeFromThis;
                        if (remainingToConsume <= 0) break;
                    }
                }
                selectedPurchaseIndices.forEach(idx => {
                    const purchaseAmt = store.history[idx].amount;
                    store.paid += purchaseAmt;
                    store.history.push({
                        date: displayDate,
                        amount: purchaseAmt,
                        type: 'Ø¯ÙØ¹',
                        source: 'savings',
                        details: []
                    });
                });
                saveToStorage();
                renderSavings();
            }

            // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„ØªØ­Ø¯ÙŠØ¯Ø§Øª ÙˆØ¥Ø¹Ø§Ø¯Ø© Ø±Ø³Ù… Ø§Ù„Ø¬Ø¯ÙˆÙ„
            selectedPurchaseIndices = [];
            renderDebtOps();
            updateDebtStats();
            renderStoresTable();
        }

        window.addDebtOp = function(type) {
            let amt = parseFloat(document.getElementById('debtOAmt').value);
            if (!amt || amt <= 0) return alert("Ø£Ø¯Ø®Ù„ Ù…Ø¨Ù„Øº ØµØ­ÙŠØ­");
            let date = document.getElementById('debtODate').value;
            let displayDate = date ? date.split('-').reverse().slice(0,2).join('/') : 'Ø§Ù„ÙŠÙˆÙ…';
            let store = db.stores[curStore];
            
            if (type === 'Ù…Ø´ØªØ±ÙŠØ§Øª') {
                store.total += amt;
                store.history.push({ date: displayDate, amount: amt, type: 'Ù…Ø´ØªØ±ÙŠØ§Øª', details: [] });
            }

            saveToStorage();
            renderDebtOps();
            updateDebtStats();
            renderStoresTable();
            document.getElementById('debtOAmt').value = '';
        };

        window.startDebtEdit = function(idx, currentAmt) {
            editStoreIdx = idx;
            document.getElementById('debtOAmt').value = currentAmt;
            document.getElementById('debtNormalBtns').style.display = 'none';
            document.getElementById('debtUpdateBtn').style.display = 'block';
            document.getElementById('paymentOptions').style.display = 'none';
        };

        window.confirmDebtUpdate = function() {
            let newAmt = parseFloat(document.getElementById('debtOAmt').value);
            if (isNaN(newAmt) || newAmt < 0) return alert("Ù‚ÙŠÙ…Ø© ØºÙŠØ± ØµØ­ÙŠØ­Ø©");
            let store = db.stores[curStore];
            let op = store.history[editStoreIdx];
            let diff = newAmt - op.amount;
            if (op.type === 'Ù…Ø´ØªØ±ÙŠØ§Øª') store.total += diff;
            else store.paid += diff;
            op.amount = newAmt;
            saveToStorage();
            renderDebtOps();
            updateDebtStats();
            renderStoresTable();
            document.getElementById('debtNormalBtns').style.display = 'flex';
            document.getElementById('debtUpdateBtn').style.display = 'none';
            document.getElementById('debtOAmt').value = '';
        };

        window.delDebtOp = function(idx) {
            let store = db.stores[curStore];
            let op = store.history[idx];
            
            if (op.type === 'Ø¯ÙØ¹' && op.source) {
                if (op.source === 'borrow') {
                    let remainingToReturn = op.amount;
                    for (let i = 0; i < db.borrows.length; i++) {
                        const borrowConsumed = db.borrows[i].consumed || 0;
                        if (borrowConsumed > 0) {
                            const returnFromThis = Math.min(borrowConsumed, remainingToReturn);
                            db.borrows[i].consumed = borrowConsumed - returnFromThis;
                            remainingToReturn -= returnFromThis;
                            if (remainingToReturn <= 0) break;
                        }
                    }
                } else if (op.source === 'savings') {
                    let remainingToReturn = op.amount;
                    for (let i = 0; i < db.savings.length; i++) {
                        const savingConsumed = db.savings[i].consumed || 0;
                        if (savingConsumed > 0) {
                            const returnFromThis = Math.min(savingConsumed, remainingToReturn);
                            db.savings[i].consumed = savingConsumed - returnFromThis;
                            remainingToReturn -= returnFromThis;
                            if (remainingToReturn <= 0) break;
                        }
                    }
                }
            }
            
            if (op.type === 'Ù…Ø´ØªØ±ÙŠØ§Øª') store.total -= op.amount;
            else store.paid -= op.amount;
            
            store.history.splice(idx, 1);
            saveToStorage();
            renderBorrows();
            renderSavings();
            renderDebtOps();
            updateDebtStats();
            renderStoresTable();
        };

        // ================ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø³Ù„Ø¹ ================
        window.openDebtDet = function(opIdx) {
            curStoreIdx = opIdx;
            window.showPage('tabDebtDet');
        };

        function renderDebtDet() {
            let op = db.stores[curStore].history[curStoreIdx];
            if (!op.details) op.details = [];
            let sum = op.details.reduce((acc, d) => acc + (d.t || 0), 0);
            let tbody = document.getElementById('debtDetTable');
            tbody.innerHTML = '';
            op.details.forEach((d, i) => {
                tbody.innerHTML += `<tr><td>${d.n}</td><td>${d.q}</td><td>${d.t}</td><td><span style="cursor:pointer;font-size:20px;" onclick="window.delDebtDet(${i})">ğŸ—‘</span></td></tr>`;
            });
            let diff = op.amount - sum;
            if (diff < 0) {
                document.getElementById('debtDetForm').style.display = 'none';
                document.getElementById('lockMsgDebt').style.display = 'block';
                tbody.innerHTML += `<tr class="over-limit-row"><td colspan="2">ğŸš« ØªØ¬Ø§ÙˆØ²</td><td>${Math.abs(diff)}</td><td>-</td></tr>`;
            } else {
                document.getElementById('debtDetForm').style.display = 'block';
                document.getElementById('lockMsgDebt').style.display = 'none';
                if (diff > 0) {
                    tbody.innerHTML += `<tr class="unknown-row"><td colspan="2">âš ï¸ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ</td><td>${diff}</td><td>-</td></tr>`;
                }
            }
        }

        window.addDebtDet = function() {
            let item = document.getElementById('debtDItem').value.trim();
            let qty = parseFloat(document.getElementById('debtDQty').value) || 1;
            let price = parseFloat(document.getElementById('debtDPrc').value);
            if (!item || !price) return alert("Ø£Ø¯Ø®Ù„ Ø§Ù„Ø³Ù„Ø¹Ø© ÙˆØ§Ù„Ø³Ø¹Ø±");
            let totalItem = qty * price;
            let op = db.stores[curStore].history[curStoreIdx];
            if (!op.details) op.details = [];
            op.details.push({ n: item, q: qty, p: price, t: totalItem });
            saveToStorage();
            renderDebtDet();
            document.getElementById('debtDItem').value = '';
            document.getElementById('debtDQty').value = '1';
            document.getElementById('debtDPrc').value = '';
            renderDebtOps();
        };

        window.delDebtDet = function(detIdx) {
            db.stores[curStore].history[curStoreIdx].details.splice(detIdx, 1);
            saveToStorage();
            renderDebtDet();
            renderDebtOps();
        };

        window.printStoreStatement = function() {
            const store = db.stores[curStore];
            if (!store) return alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØ§Ø¬Ø±');
            
            const history = store.history || [];
            const total = store.total || 0;
            const paid = store.paid || 0;
            const remaining = total - paid;
            
            let rows = '';
            for (let i = history.length - 1; i >= 0; i--) {
                const op = history[i];
                let typeText = op.type === 'Ù…Ø´ØªØ±ÙŠØ§Øª' ? 'â• Ù…Ø´ØªØ±ÙŠØ§Øª' : 'ğŸ’° Ø¯ÙØ¹';
                if (op.source === 'borrow') typeText += ' (Ù…Ù† Ø³Ù„Ù)';
                else if (op.source === 'savings') typeText += ' (Ù…Ù† Ø§Ø¯Ø®Ø§Ø±)';
                rows += `<tr><td>${op.date || 'Ø¨Ø¯ÙˆÙ† ØªØ§Ø±ÙŠØ®'}</td><td>${op.amount} Ø¯Ø¬</td><td>${typeText}</td></tr>`;
            }
            
            if (rows === '') rows = '<tr><td colspan="3">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù…Ù„ÙŠØ§Øª</td></tr>';
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html dir="rtl">
                <head>
                    <title>ÙƒØ´Ù Ø­Ø³Ø§Ø¨ Ø§Ù„ØªØ§Ø¬Ø± - ${curStore}</title>
                    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@600;700;800&display=swap" rel="stylesheet">
                    <style>
                        body { font-family: 'Cairo', sans-serif; padding: 20px; }
                        h1 { text-align: center; color: #4c46e9; }
                        .info { text-align: center; margin-bottom: 20px; }
                        .summary { display: flex; justify-content: space-around; margin: 20px 0; }
                        .summary-item { background: #f8fafc; padding: 10px; border-radius: 10px; width: 30%; text-align: center; }
                        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                        th { background: #f97316; color: white; padding: 10px; }
                        td, th { border: 1px solid #ddd; padding: 8px; text-align: center; }
                    </style>
                </head>
                <body>
                    <h1>ÙƒØ´Ù Ø­Ø³Ø§Ø¨ Ø§Ù„ØªØ§Ø¬Ø±</h1>
                    <div class="info">
                        <p><strong>Ø§Ø³Ù… Ø§Ù„ØªØ§Ø¬Ø±:</strong> ${curStore}</p>
                    </div>
                    <div class="summary">
                        <div class="summary-item"><strong>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª</strong><br>${total} Ø¯Ø¬</div>
                        <div class="summary-item"><strong>Ù…Ø¯ÙÙˆØ¹ Ù„Ù„ØªØ§Ø¬Ø±</strong><br>${paid} Ø¯Ø¬</div>
                        <div class="summary-item"><strong>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ø¹Ù„ÙŠÙƒ</strong><br>${remaining} Ø¯Ø¬</div>
                    </div>
                    <h3 style="text-align:center;">Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</h3>
                    <table>
                        <thead><tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th><th>Ø§Ù„Ù†ÙˆØ¹</th></tr></thead>
                        <tbody>${rows}</tbody>
                    </table>
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        };

        window.printDebtDetails = function() {
            const op = db.stores[curStore].history[curStoreIdx];
            if (!op) return alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù…Ù„ÙŠØ© Ù„Ø¹Ø±Ø¶Ù‡Ø§');
            
            const storeName = curStore;
            const date = op.date || 'Ø¨Ø¯ÙˆÙ† ØªØ§Ø±ÙŠØ®';
            const totalAmount = op.amount;
            
            let detailsHtml = '';
            if (op.details && op.details.length > 0) {
                op.details.forEach(d => {
                    detailsHtml += `<tr><td>${d.n}</td><td>${d.q}</td><td>${d.t} Ø¯Ø¬</td></tr>`;
                });
            } else {
                detailsHtml = '<tr><td colspan="3">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙØ§ØµÙŠÙ„</td></tr>';
            }
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html dir="rtl">
                <head>
                    <title>Ø·Ø¨Ø§Ø¹Ø© ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª</title>
                    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@600;700;800&display=swap" rel="stylesheet">
                    <style>
                        body { font-family: 'Cairo', sans-serif; padding: 20px; }
                        h1 { text-align: center; color: #4c46e9; }
                        .info { text-align: center; margin-bottom: 20px; }
                        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                        th { background: #f97316; color: white; padding: 10px; }
                        td, th { border: 1px solid #ddd; padding: 8px; text-align: center; }
                    </style>
                </head>
                <body>
                    <h1>ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª</h1>
                    <div class="info">
                        <p><strong>Ø§Ù„ØªØ§Ø¬Ø±:</strong> ${storeName}</p>
                        <p><strong>Ø§Ù„ØªØ§Ø±ÙŠØ®:</strong> ${date}</p>
                        <p><strong>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</strong> ${totalAmount} Ø¯Ø¬</p>
                    </div>
                    <table>
                        <thead>
                            <tr><th>Ø§Ù„Ø³Ù„Ø¹Ø©</th><th>Ø§Ù„ÙƒÙ…ÙŠØ©</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th></tr>
                        </thead>
                        <tbody>
                            ${detailsHtml}
                        </tbody>
                    </table>
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        };

        // ================ Ø§Ù„Ù…Ø¬Ø§Ù…ÙŠØ¹ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© Ù…Ø¹ Ø§Ù„ØµÙ Ø§Ù„Ø¥Ø¶Ø§ÙÙŠ ================
        function calcFinal() {
            const totalSavings = getTotalSavings();
            const totalSavingsConsumed = getTotalSavingsConsumed();
            const totalSavingsRemaining = getTotalSavingsRemaining();
            
            const totalBorrows = getTotalBorrows();
            const totalBorrowsConsumed = getTotalBorrowsConsumed();
            const totalBorrowsRemaining = getTotalBorrowsRemaining();
            
            const totalPurchases = getTotalStoreDebt();
            const totalPaid = getTotalPaidToStores();

            // ØªØ­Ø¯ÙŠØ« Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø¬Ø§Ù…ÙŠØ¹
            document.getElementById('totSavingsTotal').innerText = totalSavings + ' Ø¯Ø¬';
            document.getElementById('totSavingsConsumed').innerText = totalSavingsConsumed + ' Ø¯Ø¬';
            document.getElementById('totSavingsRemaining').innerText = totalSavingsRemaining + ' Ø¯Ø¬';
            
            document.getElementById('totBorrowsTotal').innerText = totalBorrows + ' Ø¯Ø¬';
            document.getElementById('totBorrowsConsumed').innerText = totalBorrowsConsumed + ' Ø¯Ø¬';
            document.getElementById('totBorrowsRemaining').innerText = totalBorrowsRemaining + ' Ø¯Ø¬';
            
            document.getElementById('totPurchasesTotal').innerText = totalPurchases + ' Ø¯Ø¬';
            document.getElementById('totPurchasesRemaining').innerText = totalPurchases + ' Ø¯Ø¬';
            
            // ØµÙ Ù…Ø¯ÙÙˆØ¹Ø§Øª Ø§Ù„ØªØ¬Ø§Ø±
            document.getElementById('totPaidToStores').innerText = totalPaid + ' Ø¯Ø¬';

            // Ø­Ø³Ø§Ø¨ Ø§Ù„ØµØ§ÙÙŠÙŠÙ†
            const netConsumed = totalPaid - (totalSavingsConsumed + totalBorrowsConsumed);
            const netRemaining = totalSavingsRemaining - totalBorrowsRemaining;

            const netConsumedEl = document.getElementById('netConsumed');
            const netRemainingEl = document.getElementById('netRemaining');
            
            netConsumedEl.innerText = netConsumed + ' Ø¯Ø¬';
            netRemainingEl.innerText = netRemaining + ' Ø¯Ø¬';
            
            netConsumedEl.className = netConsumed < 0 ? 'negative total-value' : (netConsumed > 0 ? 'positive total-value' : 'total-value');
            netRemainingEl.className = netRemaining < 0 ? 'negative total-value' : (netRemaining > 0 ? 'positive total-value' : 'total-value');
        }

        // ================ Ø§Ø³ØªÙŠØ±Ø§Ø¯ / ØªØµØ¯ÙŠØ± (ØªÙ… Ø¥ØµÙ„Ø§Ø­ Ù…Ø´ÙƒÙ„Ø© Ø¹Ø¯Ù… Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯) ================
        window.exportData = function() {
            const fileName = prompt("Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù (Ø³ÙŠØªÙ… Ø­ÙØ¸Ù‡ Ø¨Ø§Ù…ØªØ¯Ø§Ø¯ .json)", "Music");
            if (!fileName) return;
            const dataStr = JSON.stringify(db, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName + '.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        };

        window.importData = function(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedDb = JSON.parse(e.target.result);
                    if (typeof importedDb !== 'object' || importedDb === null) throw new Error('Ù…Ù„Ù ØºÙŠØ± ØµØ§Ù„Ø­');
                    
                    // Ø¯Ù…Ø¬ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªÙˆØ±Ø¯Ø© Ù…Ø¹ Ø§Ù„Ù‡ÙŠÙƒÙ„ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ Ù„Ø¶Ù…Ø§Ù† ÙˆØ¬ÙˆØ¯ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„
                    const defaultDb = { 
                        stores: {},
                        borrows: [],
                        savings: [],
                        sovereignSavings: []
                    };
                    
                    const mergedDb = {
                        stores: importedDb.stores || defaultDb.stores,
                        borrows: Array.isArray(importedDb.borrows) ? importedDb.borrows : defaultDb.borrows,
                        savings: Array.isArray(importedDb.savings) ? importedDb.savings : defaultDb.savings,
                        sovereignSavings: Array.isArray(importedDb.sovereignSavings) ? importedDb.sovereignSavings : defaultDb.sovereignSavings
                    };
                    
                    if (confirm('Ø³ÙŠØªÙ… Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ø¨Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªÙˆØ±Ø¯Ø©. Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©ØŸ')) {
                        db = mergedDb;
                        saveToStorage();
                        renderBorrows();
                        renderStoresTable();
                        renderSavings();
                        renderSovereignSavings(); // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³ÙŠØ§Ø¯ÙŠ
                        if (document.getElementById('tabHomepage').classList.contains('active')) updateHomepageChart();
                        if (document.getElementById('tabTotals').classList.contains('active')) calcFinal();
                        alert('ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­.');
                    }
                } catch (error) {
                    alert('Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù. ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù†Ù‡ Ù…Ù„Ù JSON ØµØ­ÙŠØ­.');
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        };

        window.onload = function() {
            let today = new Date().toISOString().split('T')[0];
            document.getElementById('debtODate').value = today;
            
            renderBorrows();
            renderStoresTable();
            renderSavings();
            renderSovereignSavings(); // Ø¹Ø±Ø¶ Ø§Ù„Ø³ÙŠØ§Ø¯ÙŠ
            
            showPage('tabHomepage', false);
        };

        window.calcFinal = calcFinal;
        window.renderBorrows = renderBorrows;
        window.renderStoresTable = renderStoresTable;
        window.renderDebtOps = renderDebtOps;
        window.renderDebtPaid = renderDebtPaid;
        window.renderDebtDet = renderDebtDet;
        window.renderSavings = renderSavings;
        window.renderSovereignSavings = renderSovereignSavings;
        window.updateDebtStats = updateDebtStats;
        window.updateStatusMessage = updateStatusMessage;
        window.hidePaymentOptions = hidePaymentOptions;
        window.toggleSelection = toggleSelection;
    })();
</script>
</body>
</html>
