
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#4361ee">
    
    <title>Ù…Ø¯ÙŠØ± Ø§Ù„Ø¯ÙŠÙˆÙ† Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ</title>
    
    <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIm1hbmFnZXJfZGVidHMiLAogICJzaG9ydF9uYW1lIjogImRlYnRzIiwKICAic3RhcnRfdXJsIjogIi4iLAogICJkaXNwbGF5IjogInN0YW5kYWxvbmUiLAogICJiYWNrZ3JvdW5kX2NvbG9yIjogIiM0MzYxZWUiLAogICJ0aGVtZV9jb2xvciI6ICIjNDM2MWVlIgp9">

    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@600;700;800&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary-color: #4361ee;
            --success-color: #2e7d32;
            --danger-color: #800000;
            --bg-color: #f1f3f9;
            --card-bg: #ffffff;
        }

        body {
            font-family: 'Cairo', sans-serif;
            background-color: var(--bg-color);
            margin: 0; padding: 0;
            font-size: 15px;
            font-weight: 700;
            height: 100vh; overflow: hidden;
            display: flex; flex-direction: column;
            user-select: none;
        }

        .app-header {
            background: linear-gradient(135deg, var(--primary-color), #3f37c9);
            color: white; padding: 15px;
            border-radius: 0 0 20px 20px;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-shrink: 0;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        .header-titles { text-align: center; }
        .app-header h3 { margin: 0; font-size: 18px; font-weight: 800; }
        .app-header h4 { margin: 0; font-size: 14px; color: #ffeb3b; }

        .menu-container { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); }
        .menu-dots { font-size: 26px; cursor: pointer; padding: 5px 10px; }
        .dropdown-menu {
            display: none; position: absolute; left: 0; top: 40px;
            background: white; color: #333; border-radius: 12px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.2); min-width: 160px; z-index: 1000;
        }
        .dropdown-menu div { padding: 14px 18px; font-size: 14px; border-bottom: 1px solid #f0f0f0; cursor: pointer; }
        .dropdown-menu div:last-child { border: none; }

        .container { flex: 1; overflow-y: auto; padding: 12px; padding-bottom: 90px; }

        .card {
            background: var(--card-bg);
            border-radius: 15px; padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
        }

        /* Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ø¬Ø¯ÙˆÙ„ ØªØ¯Ø¹Ù… Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„ÙƒØ«ÙŠØ±Ø© Ø¬Ø¯Ø§Ù‹ */
        .history-container {
            max-height: 350px;
            overflow-y: auto;
            border-radius: 10px;
            background: #fafafa;
            border: 1px solid #eee;
        }

        .summary-total { font-size: 28px; font-weight: 900; color: var(--primary-color); }

        input {
            width: 100%; padding: 12px; margin: 8px 0;
            border: 2px solid #e2e8f0; border-radius: 10px;
            font-size: 16px; font-family: 'Cairo'; font-weight: 700;
            box-sizing: border-box; outline: none; transition: 0.3s;
        }
        input:focus { border-color: var(--primary-color); }

        .btn {
            border: none; padding: 12px; border-radius: 10px;
            font-weight: 800; width: 100%; font-family: 'Cairo';
            font-size: 16px; cursor: pointer; transition: 0.2s;
        }
        .btn:active { transform: scale(0.98); }
        .btn-primary { background: var(--primary-color); color: white; }
        .btn-pay { background: var(--danger-color); color: white; }
        .btn-add { background: #f59e0b; color: white; }

        .stat-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin: 10px 0; }
        .stat-card { background: #fff; padding: 10px; border-radius: 10px; text-align: center; border: 2px solid #f1f5f9; }
        .stat-card small { font-size: 11px; color: #64748b; }
        .stat-card b { display: block; font-size: 14px; }

        .person-row {
            display: flex; justify-content: space-between; align-items: center;
            padding: 15px 5px; border-bottom: 1px solid #f1f5f9;
        }
        .person-info { flex: 1; cursor: pointer; display: flex; justify-content: space-between; padding-left: 15px; }
        .person-name { font-weight: 800; font-size: 16px; color: #1e293b; }
        .person-debt { color: var(--danger-color); font-weight: 900; font-size: 17px; }

        .del-account-btn { background: #fff1f2; color: #e11d48; border: 1px solid #fecdd3; padding: 6px 12px; border-radius: 8px; font-size: 12px; }

        .history-table { width: 100%; border-collapse: collapse; }
        .history-table thead { position: sticky; top: 0; background: #eee; z-index: 10; }
        .history-table th { padding: 10px; font-size: 13px; color: #475569; }
        .history-table td { padding: 12px 8px; border-bottom: 1px solid #f1f5f9; text-align: center; font-size: 14px; }

        .row-add { background-color: #fffbeb; } 
        .row-pay { background-color: #f0fdf4; }

        .bottom-nav {
            position: fixed; bottom: 0; width: 100%;
            background: white; display: flex; padding: 12px 0;
            border-top: 1px solid #e2e8f0; z-index: 100;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
        }
        .nav-item { flex: 1; text-align: center; color: #94a3b8; font-size: 14px; font-weight: 800; cursor: pointer; }
        .nav-item.active { color: var(--primary-color); }
    </style>
</head>
<body onclick="closeMenu()">

<div class="app-header">
    <div class="menu-container" onclick="event.stopPropagation()">
        <div class="menu-dots" onclick="toggleMenu()">â‹®</div>
        <div class="dropdown-menu" id="dropdownMenu">
            <div onclick="exportData()">ğŸ“¤ ØªØµØ¯ÙŠØ± Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©</div>
            <div onclick="document.getElementById('fileInput').click()">ğŸ“¥ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</div>
        </div>
    </div>
    <div class="header-titles">
        <h3>Ù…Ø¯ÙŠØ± Ø§Ù„Ø¯ÙŠÙˆÙ†</h3>
        <h4 id="subTitle">Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</h4>
    </div>
    <input type="file" id="fileInput" style="display:none" accept=".txt" onchange="importData(event)">
</div>

<div class="container">
    <div id="tab1">
        <div class="card" style="border-right: 6px solid var(--primary-color);">
            <small>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¯ÙŠÙˆÙ† Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© Ù…Ù†Ùƒ:</small>
            <div class="summary-total" id="grandTotal">0</div>
        </div>

        <div class="card">
            <label>Ø¥Ø¶Ø§ÙØ© Ø´Ø®Øµ Ø¬Ø¯ÙŠØ¯:</label>
            <input type="text" id="newName" placeholder="Ø§Ø³Ù… Ø§Ù„Ø´Ø®Øµ">
            <input type="number" id="newAmount" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø£ÙˆÙ„ÙŠ (Ø¥Ù† ÙˆØ¬Ø¯)">
            <button class="btn btn-primary" onclick="addPerson()">Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø­Ø³Ø§Ø¨Ø§Øª</button>
        </div>

        <div class="card" style="padding: 5px;">
            <div id="personsList"></div>
        </div>
    </div>

    <div id="tab2" style="display:none;">
        <div class="card">
            <div class="stat-grid">
                <div class="stat-card"><small>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</small><b id="total">0</b></div>
                <div class="stat-card"><small>Ø§Ù„Ù…Ø¯ÙÙˆØ¹</small><b id="paid" style="color:var(--success-color)">0</b></div>
                <div class="stat-card"><small>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</small><b id="remain" style="color:var(--danger-color)">0</b></div>
            </div>
            <hr style="border:0; border-top:1px solid #f1f5f9; margin:15px 0;">
            <div style="display: flex; gap: 10px;">
                <input type="date" id="opDate" style="flex: 1.2;">
                <input type="number" id="amountInput" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº" style="flex: 1;">
            </div>
            <div style="display: flex; gap: 10px;">
                <button class="btn btn-add" onclick="processAction('add')">â• Ø¥Ø¶Ø§ÙØ© Ø¯ÙŠÙ†</button>
                <button class="btn btn-pay" onclick="processAction('pay')">ğŸ’µ Ø§Ø³ØªÙ„Ø§Ù… Ø³Ø¯Ø§Ø¯</button>
            </div>
        </div>

        <div class="card" style="padding: 0;">
            <div class="history-container">
                <table class="history-table">
                    <thead><tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>-</th></tr></thead>
                    <tbody id="historyList"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div class="bottom-nav">
    <div class="nav-item active" id="navHome" onclick="openTab(1, this)">ğŸ  Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</div>
    <div class="nav-item" id="navOps" onclick="openTab(2, this)">ğŸ’¸ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</div>
</div>

<script>
    // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø¯Ù…Ø© Ù„Ù„Ø¹Ù…Ù„ Ø¨Ø¯ÙˆÙ† Ø¥Ù†ØªØ±Ù†Øª
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('data:text/javascript;base64,c2VsZi5hZGRFdmVudExpc3RlbmVyKCdmZXRjaCcsIGU9PntlLnJlc3BvbmRXaXRoKGZldGNoKGUucmVxdWVzdCkuY2F0Y2goKCk9PmNhY2hlcy5tYXRjaChlLnJlcXVlc3QpKSl9KTs=');
        });
    }

    const DB_NAME = "DEBTS_FINAL_OFFLINE_V1";
    let data = JSON.parse(localStorage.getItem(DB_NAME)) || {};
    let activePerson = "";

    function toggleMenu() {
        const menu = document.getElementById('dropdownMenu');
        menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
    }

    function closeMenu() { document.getElementById('dropdownMenu').style.display = 'none'; }

    function save() {
        localStorage.setItem(DB_NAME, JSON.stringify(data));
        renderHome();
    }

    function renderHome() {
        const listDiv = document.getElementById('personsList');
        const grandTotalDiv = document.getElementById('grandTotal');
        listDiv.innerHTML = '';
        let grandTotal = 0;

        for (let name in data) {
            let remain = data[name].total - data[name].paid;
            grandTotal += remain;
            listDiv.innerHTML += `
                <div class="person-row">
                    <div class="person-info" onclick="goToPerson('${name}')">
                        <span class="person-name">${name}</span>
                        <span class="person-debt">${remain.toLocaleString()}</span>
                    </div>
                    <button class="del-account-btn" onclick="deletePersonFull('${name}')">Ø­Ø°Ù</button>
                </div>`;
        }
        grandTotalDiv.textContent = grandTotal.toLocaleString();
    }

    function addPerson() {
        const name = document.getElementById('newName').value.trim();
        const amt = Number(document.getElementById('newAmount').value) || 0;
        if (!name || data[name]) return alert("Ø§Ù„Ø§Ø³Ù… Ù…ÙˆØ¬ÙˆØ¯ Ø£Ùˆ ØºÙŠØ± ØµØ§Ù„Ø­");
        
        data[name] = { total: amt, paid: 0, history: [] };
        if (amt > 0) {
            data[name].history.push({ id: Date.now(), date: formatDate(new Date()), type: 'Ø¥Ø¶Ø§ÙØ©', amount: amt });
        }
        document.getElementById('newName').value = '';
        document.getElementById('newAmount').value = '';
        save();
    }

    function goToPerson(name) {
        activePerson = name;
        openTab(2, document.getElementById('navOps'));
        loadData();
    }

    function loadData() {
        if (!activePerson) return;
        document.getElementById('subTitle').textContent = "Ø­Ø³Ø§Ø¨ " + activePerson;
        const p = data[activePerson];
        document.getElementById('total').textContent = p.total.toLocaleString();
        document.getElementById('paid').textContent = p.paid.toLocaleString();
        document.getElementById('remain').textContent = (p.total - p.paid).toLocaleString();

        const hList = document.getElementById('historyList');
        hList.innerHTML = p.history.slice().reverse().map(h => `
            <tr class="${h.type === 'Ø¥Ø¶Ø§ÙØ©' ? 'row-add' : 'row-pay'}">
                <td>${h.date}</td>
                <td style="color:${h.type === 'Ø¯ÙØ¹' ? 'green' : 'brown'}"><b>${h.amount.toLocaleString()}</b></td>
                <td>${h.type}</td>
                <td><button onclick="deleteItem('${activePerson}', ${h.id})" style="border:none; background:none; color:red;">âŒ</button></td>
            </tr>`).join('');
    }

    function processAction(type) {
        if (!activePerson) return;
        const val = Number(document.getElementById('amountInput').value);
        if (!val) return;
        
        const dateInput = document.getElementById('opDate').value;
        const d = dateInput ? dateInput.split('-').reverse().slice(0,2).join('/') : formatDate(new Date());
        
        if (type === 'add') data[activePerson].total += val;
        else data[activePerson].paid += val;

        data[activePerson].history.push({ id: Date.now(), date: d, type: type === 'add' ? 'Ø¥Ø¶Ø§ÙØ©' : 'Ø¯ÙØ¹', amount: val });
        document.getElementById('amountInput').value = '';
        save(); loadData();
    }

    function deleteItem(personName, itemId) {
        if (!confirm("Ø­Ø°Ù Ø§Ù„Ø¹Ù…Ù„ÙŠØ©ØŸ")) return;
        const person = data[personName];
        const idx = person.history.findIndex(h => h.id === itemId);
        const item = person.history[idx];
        if (item.type === 'Ø¥Ø¶Ø§ÙØ©') person.total -= item.amount;
        else person.paid -= item.amount;
        person.history.splice(idx, 1);
        save(); loadData();
    }

    function deletePersonFull(name) {
        if (confirm(`Ø­Ø°Ù Ø­Ø³Ø§Ø¨ ${name} Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ`)) {
            delete data[name];
            save();
            renderHome();
        }
    }

    function openTab(num, el) {
        document.getElementById('tab1').style.display = num === 1 ? 'block' : 'none';
        document.getElementById('tab2').style.display = num === 2 ? 'block' : 'none';
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        el.classList.add('active');
        if (num === 1) {
            document.getElementById('subTitle').textContent = "Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©";
            activePerson = "";
        }
    }

    function formatDate(date) { return date.getDate() + "/" + (date.getMonth() + 1); }

    function exportData() {
        const text = JSON.stringify(data);
        const blob = new Blob([text], { type: 'text/plain' });
        const anchor = document.createElement('a');
        anchor.download = "Ù†Ø³Ø®Ø©_Ø§Ù„Ø¯ÙŠÙˆÙ†.txt";
        anchor.href = window.URL.createObjectURL(blob);
        anchor.click();
    }

    function importData(event) {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                data = JSON.parse(e.target.result);
                save(); renderHome();
                alert("ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­");
            } catch { alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…Ù„Ù"); }
        };
        reader.readAsText(file);
    }

    window.onload = () => { renderHome(); document.getElementById('opDate').value = new Date().toISOString().split('T')[0]; };
</script>
</body>
</html>
